# HoroloGen Architecture

## 0. ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ç›®çš„
HoroloGen ã¯ã€Œæ­£è¦æ™‚è¨ˆåº—ã§ä½¿ã†å•†å“ç´¹ä»‹æ–‡ã€ã‚’ã€**ä»•æ§˜ã«å¿ å®Ÿ**ã‹ã¤**èª‡å¼µã›ãš**ã«ç”Ÿæˆã™ã‚‹ãŸã‚ã®ç¤¾å†…å‘ã‘Webã‚¢ãƒ—ãƒªã§ã™ã€‚  
ã“ã®æ–‡æ›¸ã¯ã€è¨­è¨ˆã®å…¨ä½“åƒãƒ»ä¸å¤‰æ¡ä»¶ï¼ˆå£Šã—ã¦ã¯ã„ã‘ãªã„ã¨ã“ã‚ï¼‰ãƒ»ä¸»è¦ãƒ•ãƒ­ãƒ¼ã‚’é–‹ç™ºè€…å‘ã‘ã«ã¾ã¨ã‚ã¾ã™ã€‚

---

## 1. ä½•ã‚’ä½œã£ã¦ã„ã‚‹ã‹ï¼ˆOverviewï¼‰
- Flask + SQLite ã®å°ã•ãªç®¡ç†ç”»é¢ã‚¢ãƒ—ãƒª
- å•†å“ãƒã‚¹ã‚¿ï¼ˆCSVï¼‰ã¨å€‹åˆ¥ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ï¼ˆãƒ•ã‚©ãƒ¼ãƒ ï¼‰ã‚’çµ±åˆã—ã€canonicalä»•æ§˜ã‚’ç¢ºå®š
- LLMï¼ˆAnthropic Claudeï¼‰ã«å…¥åŠ›ã—ã¦ intro/specs ã‚’ç”Ÿæˆ
- ç”Ÿæˆå±¥æ­´ãƒ»é¡ä¼¼åº¦ãƒ»è¨€ã„æ›ãˆï¼ˆæœ€å¤§1å›ï¼‰ãƒ»æœˆé–“ã‚¯ã‚©ãƒ¼ã‚¿ã‚’ç®¡ç†

---

## 2. èª°å‘ã‘ã‹ï¼ˆUsersï¼‰
- æ­£è¦æ™‚è¨ˆåº—ã‚¹ã‚¿ãƒƒãƒ•ï¼ˆè²©å£²ãƒ»ECé‹ç”¨ãƒ»åºƒå‘Šåˆ¶ä½œï¼‰
- ã€Œå•†å“èª¬æ˜æ–‡ã‚’é€Ÿããƒ»å®‰å…¨ã«ãƒ»ä»•æ§˜ã®å˜˜ãªãã€ä½œã‚ŠãŸã„é‹ç”¨è€
    â†’ ãƒ–ãƒ©ãƒ³ãƒ‰/ãƒ¡ãƒ¼ã‚«ãƒ¼ã / ç…½ã‚‰ãªãâ†’ è³¼è²·èª˜å°ãƒ»è³‡ç”£æ€§æ–­å®šãªã©ã¯ç¦æ­¢ï¼ˆæ¤œå‡ºã—ãŸã‚‰è½ã¨ã™ï¼‰ã€‚
- **å‚ç…§URLã¯è£œåŠ©**  
  â†’ èƒŒæ™¯ãƒ»æ–‡è„ˆè£œå¼·ã«ä½¿ã†ãŒã€ä»•æ§˜æ ¹æ‹ ã«ã¯ã—ãªã„ã€‚ã‚³ãƒ”ãƒšã¯ç¦æ­¢ï¼ˆåŒç¾©è¨€ã„æ›ãˆï¼‰ã€‚
- **å…¬é–‹å‰æã®å®‰å…¨è¨­è¨ˆ**  
  â†’ ç„¡åˆ¶é™æ¶ˆè²»ï¼ˆã‚³ã‚¹ãƒˆäº‹æ•…ï¼‰ãƒ»æƒ…å ±éœ²å‡ºãƒ»å¤šé‡å®Ÿè¡Œã‚’æœ€åˆã‹ã‚‰æ½°ã™ã€‚
- **é‹ç”¨å„ªå…ˆ**  
  â†’ UIã§äº‹æ•…ã‚’æ¸›ã‚‰ã—ã€DBã§å±¥æ­´ã¨ã‚¬ãƒ¼ãƒ‰ï¼ˆè¨€ã„æ›ãˆ1å›ã€æœˆé–“3 editor_note ã®æ‰±ã„
- editor_note ã¯ intro_text ã«å¿…ãšåæ˜ ï¼ˆæœªå…¥åŠ›ã®å ´åˆã¯è§¦ã‚Œãªã„ï¼‰
- ãƒˆãƒ¼ãƒ³åˆ¥ã«è¨€ã„å›ã—ã‚’èª¿æ•´ã—ã¦ã‚ˆã„ãŒã€è¶£æ—¨ã¯å¿…ãšä¿æŒã™ã‚‹

### 5.4 èªã‚Šæ‰‹ãƒ«ãƒ¼ãƒ«
- intro_text ã®èªã‚Šæ‰‹ã¯ã€Œæ­£è¦æ™‚è¨ˆåº—ã‚¹ã‚¿ãƒƒãƒ•ã€
- ãƒ–ãƒ©ãƒ³ãƒ‰/ãƒ¡ãƒ¼ã‚«ãƒ¼ãŒèªã‚‹è¡¨ç¾ã€èª­è€…ãŒèªã‚‹è¡¨ç¾ã¯ç¦æ­¢

### 5.5 è¨€ã„æ›ãˆï¼ˆæœ€å¤§1å›ï¼‰ã‚¬ãƒ¼ãƒ‰
- UIã ã‘ã§ãªã **ã‚µãƒ¼ãƒå´ï¼ˆDBï¼‰ã§ä¿è¨¼**ã™ã‚‹
- rewrite_parent_id ã‹ã‚‰ã®è¨€ã„æ›ãˆå±¥æ­´ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ãªã‚‰ãƒ–ãƒ­ãƒƒã‚¯
- depth>=1 ã®å±¥æ­´ã‚’è¦ªã«ã™ã‚‹ã“ã¨ã‚‚ç¦æ­¢

### 5.6 ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- ç”»é¢è¡¨ç¤ºã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼åget_db_connection()
- ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã€å¿…è¦ã‚«ãƒ©ãƒ è¿½åŠ ï¼ˆå­˜åœ¨ã—ãªã‘ã‚Œã°ALTERï¼‰

### 6.3 llm_client.pyï¼ˆLLM & URLæœ¬æ–‡å–å¾—ï¼‰
- TRUST_SOURCESï¼ˆãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆï¼‰
- fetch_page_textï¼ˆURLæœ¬æ–‡æŠ½å‡ºï¼‰
- build_system / build_user_promptï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰
- generate_articleï¼ˆé€šå¸¸ç”Ÿæˆ + è¨€ã„æ›ãˆ + é¡ä¼¼åº¦ï¼‰
- toolå‡ºåŠ›ã®ä¿é™ºï¼ˆtool_useãŒè¿”ã‚‰ãªã„å ´åˆã®JSONæŠ½å‡ºãªã©ï¼‰

### 6.4 templates/search.html
- canonicalè¡¨ç¤ºã€ç”Ÿæˆãƒ•ã‚©ãƒ¼ãƒ ã€ç”Ÿæˆçµæœã€é¡ä¼¼åº¦ã€è¨€ã„æ›ãˆãƒœã‚¿ãƒ³ã€å±¥æ­´ã€ã‚¯ã‚©ãƒ¼ã‚¿è¡¨ç¤º
- ã€Œçµæœè¡¨ç¤ºä¸­ã«ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒ­ãƒƒã‚¯ã€ç­‰ã®UIäº‹æ•…é˜²æ­¢

---

## 7. ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ï¼ˆSQLiteï¼‰
### 7.1 master_products
- CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆã§æ›´æ–°ã•ã‚Œã‚‹ã€Œæ­£ã€ï¼ˆåŸå‰‡ã“ã“ãŒã‚½ãƒ¼ã‚¹ï¼‰ã§ master + override ã‚’å–å¾—
2) canonical_specs ã‚’åˆæˆ
3) payload ã‚’çµ„ã¿ç«‹ã¦ï¼ˆtone, options, editor_note, reference_urlsï¼‰
4) consume_quota_or_block(n=1)
5) llm_client.generate_article(rewrite_mode="none")
6) generated_articles ã«ä¿å­˜ï¼ˆdepth=0ï¼‰
7) ç”»é¢ã«çµæœ + é¡ä¼¼åº¦ + è¨€ã„æ›ãˆãƒœã‚¿ãƒ³ï¼ˆ1å›ã®ã¿ï¼‰è¡¨ç¤º

### 8.2 è¨€ã„æ›ãˆï¼ˆæœ€å¤§1å›ï¼‰
1) source_article_id ã‚’å—ã‘å–ã‚‹
2) generated_articles ã‹ã‚‰ payload_json ã‚’å–å¾—
3) ã‚µãƒ¼ãƒå´ã‚¬ãƒ¼ãƒ‰ï¼š
   - rewrite_parent_id = source_article_id ã®å±¥æ­´ãŒæ—¢ã«å­˜åœ¨ â†’ ãƒ–ãƒ­ãƒƒã‚¯
   - source ã® rewrite_depth >= 1 â†’ ãƒ–ãƒ­ãƒƒã‚¯
4) consume_quota_or_block(n=1)
5) llm_client.generate_article(rewrite_mode="force")
6) generated_articles ã«ä¿å­˜ï¼ˆdepth=1, parent=sourceï¼‰
7) ç”»é¢ã«çµæœè¡¨ç¤ºï¼ˆå†è¨€ã„æ›ãˆä¸å¯ï¼‰

---

## 9. å¤±æ•—ã—ã‚„ã™ã„ç‚¹ã¨å¯¾ç­–ï¼ˆPitfallsï¼‰
### 9.1 render_template ã®é‡è¤‡kwargs
- `**debug_defaults` ã‚’æ¸¡ã—ã¤ã¤å€‹åˆ¥ã«åŒã˜ã‚­ãƒ¼ã‚’æ¸¡ã™ã¨ TypeError ãç”»é¢ã«æ®‹ã£ãŸçŠ¶æ…‹ã§ãƒˆãƒ¼ãƒ³/ãƒã‚§ãƒƒã‚¯/URLã‚’è§¦ã‚‹ã¨æ··ä¹±ãŒèµ·ã“ã‚‹
- å¯¾ç­–ï¼šçµæœè¡¨ç¤ºä¸­ã¯UIã‚’ãƒ­ãƒƒã‚¯ï¼ˆãƒˆãƒ¼ãƒ³/ãƒã‚§ãƒƒã‚¯/URLã‚’ disabledï¼‰

---

## 10. è¨­å®šï¼ˆEnvironment Variablesï¼‰
- HOROLOGEN_PLAN: limited / unlimited
- HOROLOGEN_MONTHLY_LIMIT: 30ï¼ˆlimitedæ™‚ï¼‰
- HOROLOGEN_CLAUDE_MODEL: ä¾‹ï¼‰claude-sonnet-4-5
- ANTHROPIC_API_KEY: å¿…é ˆï¼ˆLLMåˆ©ç”¨ï¼‰

---

## 11. ãƒ­ã‚°ã¨é‹ç”¨
- ç”»é¢ï¼šäººé–“å‘ã‘æ–‡è¨€ï¼ˆè©³ç´°ã¯å‡ºã•ãªã„ï¼‰
- ãƒ­ã‚°ï¼šä¾‹å¤–å…¨æ–‡ + stack trace + request contextï¼ˆå¯èƒ½ãªã‚‰ï¼‰
- æœ¬ç•ªå…¬é–‹å‰ï¼š
  - secret_key ã‚’ç’°å¢ƒå¤‰æ•°åŒ–
  - èªè¨¼ãƒ»CSRFãƒ»ãƒ¬ãƒ¼ãƒˆåˆ¶é™
  - DBãƒ‘ã‚¹ã®ç’°å¢ƒå¤‰æ•°åŒ–
  - backup é‹ç”¨ï¼ˆdbãƒ•ã‚¡ã‚¤ãƒ«ï¼‰

---
