{% extends "base.html" %}

{% block title %}Staff: æ¤œç´¢ãƒ»ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ - HoroloGen{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='staff_search_v0.css') }}">
{% endblock %}

{% block content %}
<div class="staff-search-v0">
<div class="v0-page-head">
  <h1>Staff: æ¤œç´¢ãƒ»ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰</h1>
  <p>ãƒ–ãƒ©ãƒ³ãƒ‰ã¨ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã‚’æŒ‡å®šã—ã¦ã€ä»•æ§˜ç¢ºèªãƒ»è¨˜äº‹ç”Ÿæˆãƒ»ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ç·¨é›†ã‚’è¡Œãˆã¾ã™ã€‚</p>
</div>

<section class="v0-card v0-card-search">
<h2><span class="v0-title-icon">ğŸ”</span>æ¤œç´¢</h2>
<form method="POST" class="v0-search-form">
  <input type="hidden" name="action" value="search">
  <div class="form-group v0-field">
    <label for="brand">ãƒ–ãƒ©ãƒ³ãƒ‰</label>
    <select id="brand" name="brand" required>
      <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
      {% for b in brands %}
      <option value="{{ b }}" {% if brand == b %}selected{% endif %}>{{ b }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="form-group v0-field">
    <div id="ref_count" class="v0-muted">ç™»éŒ²æ•°: -</div>
    <label for="reference">ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹</label>
    <input type="text" id="reference" name="reference" list="reference_list" value="{{ reference or '' }}" required>
    <datalist id="reference_list"></datalist>
    <span id="ref_loading" class="v0-loading" style="display:none;">èª­ã¿è¾¼ã¿ä¸­â€¦</span>
  </div>

  <button type="submit" class="v0-primary-btn">æ¤œç´¢</button>
</form>
</section>

{% if warnings %}
  {% for warning in warnings %}
  <div class="alert alert-warning">{{ warning }}</div>
  {% endfor %}
{% endif %}

{% if override_warning %}
  <div class="alert alert-warning">
    <strong>è­¦å‘Š:</strong> {{ override_warning }}
    {% if import_conflict_warning %}
    <br><strong>è¿½åŠ è­¦å‘Š:</strong> {{ import_conflict_warning }}
    {% endif %}
  </div>
{% endif %}

{% if override %}
<div class="v0-inline-actions">
  <form method="POST" style="display: inline;">
    <input type="hidden" name="action" value="delete_override">
    <input type="hidden" name="brand" value="{{ brand }}">
    <input type="hidden" name="reference" value="{{ reference }}">
    <button type="submit" class="btn btn-danger" onclick="return confirm('ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã‚’è§£é™¤ã—ã¦ãƒã‚¹ã‚¿ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')">
      ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰è§£é™¤ï¼ˆãƒã‚¹ã‚¿ã«æˆ»ã™ï¼‰
    </button>
  </form>
</div>
{% endif %}

{% if canonical %}
<section class="v0-card v0-card-canonical">
  <details class="canonical-specs-collapsible">
    <summary><span class="v0-title-icon">ğŸ“š</span>â–¶ æ­£è¦ä»•æ§˜ï¼ˆCanonical Specsï¼‰<span class="v0-collapsible-hint"></span></summary>
    <div class="specs-grid">
      {% for field, value in canonical.items() %}
      <div class="spec-card {% if field in overridden_fields %}override-field{% endif %}">
        <div class="spec-label">
          {{ field }}
          {% if field in overridden_fields %}
          <span class="override-badge">ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰</span>
          {% endif %}
        </div>
        <div class="spec-value">{{ value or '(ç©º)' }}</div>
      </div>
      {% endfor %}
    </div>
  </details>
</section>

  <section class="v0-card v0-card-override">
  <h2><span class="v0-title-icon">âš™ï¸</span>ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ç·¨é›†</h2>
  <form method="POST">
    <input type="hidden" name="action" value="save_override">
    <input type="hidden" name="brand" value="{{ brand }}">
    <input type="hidden" name="reference" value="{{ reference }}">

    <details class="form-group">
      <summary>ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰è©³ç´°é …ç›®<span class="v0-collapsible-hint"></span></summary>
      <div class="specs-grid">
      <div class="form-group">
        <label for="price_jpy">ä¾¡æ ¼ (JPY)</label>
        <input type="text" id="price_jpy" name="price_jpy" value="{{ override.price_jpy if override else '' }}" placeholder="{{ master.price_jpy if master else '' }}">
      </div>

      <div class="form-group">
        <label for="case_size_mm">ã‚±ãƒ¼ã‚¹ã‚µã‚¤ã‚º (mm)</label>
        <input type="text" id="case_size_mm" name="case_size_mm" value="{{ override.case_size_mm if override else '' }}" placeholder="{{ master.case_size_mm if master else '' }}">
      </div>

      <div class="form-group">
        <label for="movement">ãƒ ãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆ</label>
        <select id="movement" name="movement">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="automatic" {% if override and override.movement == 'automatic' %}selected{% endif %}>automatic</option>
          <option value="manual" {% if override and override.movement == 'manual' %}selected{% endif %}>manual</option>
          <option value="quartz" {% if override and override.movement == 'quartz' %}selected{% endif %}>quartz</option>
          <option value="Spring Drive automatic" {% if override and override.movement == 'Spring Drive automatic' %}selected{% endif %}>Spring Drive automatic</option>
          <option value="Manual winding" {% if override and override.movement == 'Manual winding' %}selected{% endif %}>Manual winding</option>
        </select>
        {% if master and master.movement %}
        <small style="color: #666;">ãƒã‚¹ã‚¿å€¤: {{ master.movement }}</small>
        {% endif %}
      </div>

      <div class="form-group">
        <label for="case_material">ã‚±ãƒ¼ã‚¹æè³ª</label>
        <input type="text" id="case_material" name="case_material" value="{{ override.case_material if override else '' }}" placeholder="{{ master.case_material if master else '' }}">
      </div>

      <div class="form-group">
        <label for="bracelet_strap">ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆ/ã‚¹ãƒˆãƒ©ãƒƒãƒ—</label>
        <select id="bracelet_strap" name="bracelet_strap">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="bracelet" {% if override and override.bracelet_strap == 'bracelet' %}selected{% endif %}>bracelet</option>
          <option value="strap" {% if override and override.bracelet_strap == 'strap' %}selected{% endif %}>strap</option>
        </select>
        {% if master and master.bracelet_strap %}
        <small style="color: #666;">ãƒã‚¹ã‚¿å€¤: {{ master.bracelet_strap }}</small>
        {% endif %}
      </div>

      <div class="form-group">
        <label for="dial_color">ãƒ€ã‚¤ã‚¢ãƒ«ã‚«ãƒ©ãƒ¼</label>
        <input type="text" id="dial_color" name="dial_color" value="{{ override.dial_color if override else '' }}" placeholder="{{ master.dial_color if master else '' }}">
      </div>

      <div class="form-group">
        <label for="water_resistance_m">è€æ°´æ€§èƒ½ (m)</label>
        <input type="text" id="water_resistance_m" name="water_resistance_m" value="{{ override.water_resistance_m if override else '' }}" placeholder="{{ master.water_resistance_m if master else '' }}">
      </div>

      <div class="form-group">
        <label for="buckle">ãƒãƒƒã‚¯ãƒ«</label>
        <select id="buckle" name="buckle">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="pin" {% if override and override.buckle == 'pin' %}selected{% endif %}>pin</option>
          <option value="D" {% if override and override.buckle == 'D' %}selected{% endif %}>D</option>
        </select>
        {% if master and master.buckle %}
        <small style="color: #666;">ãƒã‚¹ã‚¿å€¤: {{ master.buckle }}</small>
        {% endif %}
      </div>

      <div class="form-group">
        <label for="warranty_years">ä¿è¨¼æœŸé–“ (å¹´)</label>
        <input type="text" id="warranty_years" name="warranty_years" value="{{ override.warranty_years if override else '' }}" placeholder="{{ master.warranty_years if master else '' }}">
      </div>

      <div class="form-group">
        <label for="collection">ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</label>
        <input type="text" id="collection" name="collection" value="{{ override.collection if override else '' }}" placeholder="{{ master.collection if master else '' }}">
      </div>

      <div class="form-group">
        <label for="movement_caliber">ãƒ ãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆã‚­ãƒ£ãƒªãƒãƒ¼</label>
        <input type="text" id="movement_caliber" name="movement_caliber" value="{{ override.movement_caliber if override else '' }}" placeholder="{{ master.movement_caliber if master else '' }}">
      </div>

      <div class="form-group">
        <label for="case_thickness_mm">ã‚±ãƒ¼ã‚¹åšã• (mm)</label>
        <input type="text" id="case_thickness_mm" name="case_thickness_mm" value="{{ override.case_thickness_mm if override else '' }}" placeholder="{{ master.case_thickness_mm if master else '' }}">
      </div>

      <div class="form-group">
        <label for="lug_width_mm">ãƒ©ã‚°å¹… (mm)</label>
        <input type="text" id="lug_width_mm" name="lug_width_mm" value="{{ override.lug_width_mm if override else '' }}" placeholder="{{ master.lug_width_mm if master else '' }}">
      </div>

      <div class="form-group" style="grid-column: 1 / -1;">
        <label for="remarks">å‚™è€ƒ</label>
        <textarea id="remarks" name="remarks" rows="3">{{ override.remarks if override else '' }}</textarea>
        {% if master and master.remarks %}
        <small style="color: #666;">ãƒã‚¹ã‚¿å€¤: {{ master.remarks }}</small>
        {% endif %}
      </div>
      </div>
    </details>

    <div class="form-group" style="grid-column: 1 / -1; margin-top: 15px;">
      <label for="editor_note">ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ å…¥åŠ›ï¼ˆå¿…ãšæ–‡ç« ã«åæ˜ ã•ã‚Œã¾ã™ï¼‰</label>
      <textarea
        id="editor_note"
        name="editor_note"
        rows="4"
        placeholder="æ¥å®¢ã§ã®å®Ÿä½“é¨“ãƒ»å•†å“ã®é­…åŠ›ãƒ»ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ãªã©ã‚’è‡ªç”±ã«è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚">{{ override.editor_note if override and override.editor_note else '' }}</textarea>

      <small style="color:#666;">
        â€»ã“ã“ã«å…¥åŠ›ã—ãŸå†…å®¹ã¯ã€â€ã‚¹ãƒšãƒƒã‚¯ä¸Šæ›¸ãä¿å­˜â€ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨å•†å“ç´¹ä»‹æ–‡ã«å¿…ãšåæ˜ ã•ã‚Œã¾ã™ã€‚
      </small>
    </div>

    <button type="submit" style="margin-top: 20px;">ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã‚’ä¿å­˜</button>
  </form>
</section>

  <section class="v0-card v0-card-article">
  <h2><span class="v0-title-icon">âœ¨</span>è¨˜äº‹ç”Ÿæˆï¼ˆãƒ€ãƒŸãƒ¼ï¼‰</h2>
  <div class="v0-article-meta">
    <div>ãƒ—ãƒ©ãƒ³: {{ plan_mode }}</div>
    <div>å¯¾è±¡æœˆ: {{ month_key }}</div>
    {% if plan_mode == 'unlimited' %}
      <div>æ®‹ã‚Š: ç„¡åˆ¶é™</div>
    {% else %}
      <div>æ®‹ã‚Š: {{ monthly_remaining }} / {{ monthly_limit }}</div>
    {% endif %}
  </div>

  {% set locked = (generated_intro_text or generated_specs_text) %}
  <form method="POST" style="margin-bottom: 30px;">
    <input type="hidden" name="action" value="generate_dummy">
    <input type="hidden" name="brand" value="{{ brand }}">
    <input type="hidden" name="reference" value="{{ reference }}">
    {% if locked %}
      <input type="hidden" name="tone" value="{{ generation_tone if generation_tone else 'casual_friendly' }}">
      <input type="hidden" name="include_brand_profile" value="{{ 'on' if generation_include_brand_profile else 'off' }}">
      <input type="hidden" name="include_wearing_scenes" value="{{ 'on' if generation_include_wearing_scenes else 'off' }}">
      <input type="hidden" name="reference_url_1" value="{{ generation_reference_urls[0] if generation_reference_urls and generation_reference_urls|length > 0 else '' }}">
      <input type="hidden" name="reference_url_2" value="{{ generation_reference_urls[1] if generation_reference_urls and generation_reference_urls|length > 1 else '' }}">
      <input type="hidden" name="reference_url_3" value="{{ generation_reference_urls[2] if generation_reference_urls and generation_reference_urls|length > 2 else '' }}">
    {% endif %}

    <div class="form-group">
      <label for="tone">ãƒˆãƒ¼ãƒ³</label>
      <select id="tone" name="tone" required {% if locked %}disabled{% endif %}>
        <option value="luxury" {% if generation_tone == 'luxury' %}selected{% endif %}>ãƒ•ã‚©ãƒ¼ãƒãƒ«ãƒ»æ¨©å¨å‹ï¼ˆluxuryï¼‰</option>
        <option value="casual_friendly" {% if generation_tone == 'casual_friendly' or not generation_tone %}selected{% endif %}>ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ»è¦ªã—ã¿å‹ï¼ˆcasual_friendlyï¼‰</option>
        <option value="magazine_story" {% if generation_tone == 'magazine_story' %}selected{% endif %}>ã‚¹ãƒˆãƒ¼ãƒªãƒ¼å‹ï¼ˆmagazine_storyï¼‰</option>
        <option value="practical" {% if generation_tone == 'practical' %}selected{% endif %}>å®Ÿç”¨ãƒ»æ¨™æº–ï¼ˆpracticalï¼‰</option>
      </select>
    </div>

    <div class="form-group">
      <label>
        <input type="checkbox" name="include_brand_profile" {% if generation_include_brand_profile %}checked{% endif %} {% if locked %}disabled{% endif %}>
        ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å«ã‚ã‚‹
      </label>
    </div>

    <div class="form-group">
      <label>
        <input type="checkbox" name="include_wearing_scenes" {% if generation_include_wearing_scenes %}checked{% endif %} {% if locked %}disabled{% endif %}>
        è£…ç€ã‚·ãƒ¼ãƒ³ã‚’å«ã‚ã‚‹
      </label>
    </div>

    <div class="form-group">
      <label>å‚è€ƒURLï¼ˆä»»æ„ãƒ»æœ€å¤§3æœ¬ï¼‰</label>

      <input
        type="url"
        name="reference_url_1"
        value="{{ generation_reference_urls[0] if generation_reference_urls and generation_reference_urls|length > 0 else '' }}"
        placeholder="å‚è€ƒURL 1ï¼ˆæ¨å¥¨ï¼‰: https://..."
        style="width: 100%; margin-bottom: 8px;"
        {% if locked %}disabled{% endif %}
      >

      <input
        type="url"
        name="reference_url_2"
        value="{{ generation_reference_urls[1] if generation_reference_urls and generation_reference_urls|length > 1 else '' }}"
        placeholder="å‚è€ƒURL 2ï¼ˆä»»æ„ï¼‰: https://..."
        style="width: 100%; margin-bottom: 8px;"
        {% if locked %}disabled{% endif %}
      >

      <input
        type="url"
        name="reference_url_3"
        value="{{ generation_reference_urls[2] if generation_reference_urls and generation_reference_urls|length > 2 else '' }}"
        placeholder="å‚è€ƒURL 3ï¼ˆä»»æ„ï¼‰: https://..."
        style="width: 100%;"
        {% if locked %}disabled{% endif %}
      >

      <small style="color:#666;">
        å…¬å¼ / æ­£è¦ä»£ç†åº— / è¨±å¯ãƒ¡ãƒ‡ã‚£ã‚¢ãªã©ã€ä¿¡é ¼ã§ãã‚‹ãƒšãƒ¼ã‚¸ã‚’æœ€å¤§3æœ¬ã¾ã§è²¼ã‚Œã¾ã™ï¼ˆãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆå¤–ã¯å–å¾—ã•ã‚Œã¾ã›ã‚“ï¼‰
      </small>
    </div>

    {% set quota_ok = (plan_mode == 'unlimited') or (monthly_remaining|default(0) > 0) %}
    <button type="submit" class="v0-generate-btn" {% if not quota_ok %}disabled{% endif %}>è¨˜äº‹ç”Ÿæˆï¼ˆãƒ€ãƒŸãƒ¼ï¼‰</button>
    {% if not quota_ok %}
      <div style="color:#c00; font-size:12px; margin-top:6px;">â€»ä»Šæœˆã®ç”Ÿæˆä¸Šé™ã«é”ã—ã¦ã„ã¾ã™</div>
    {% endif %}
  </form>

  {% if generated_intro_text or generated_specs_text %}
    <h3>ç”Ÿæˆçµæœ</h3>
    {% if generation_elapsed_sec is defined and generation_elapsed_sec is not none %}
      <div style="color:#666; font-size:12px; margin-bottom:8px;">æ‰€è¦æ™‚é–“: {{ '%.1f'|format(generation_elapsed_sec) }}ç§’</div>
    {% elif rewrite_elapsed_sec is defined and rewrite_elapsed_sec is not none %}
      <div style="color:#666; font-size:12px; margin-bottom:8px;">æ‰€è¦æ™‚é–“: {{ '%.1f'|format(rewrite_elapsed_sec) }}ç§’</div>
    {% endif %}

    {% if selected_reference_url %}
      <div class="alert alert-info" style="margin-bottom: 12px;">
        <div><strong>å‚è€ƒURLæ¡ç”¨:</strong> {{ selected_reference_url }}</div>
        {% if selected_reference_reason %}
        <div><strong>ç†ç”±:</strong> {{ selected_reference_reason }}</div>
        {% endif %}
      </div>
    {% endif %}

    {% set sim_cls = similarity_level|default('blue') %}
    <div class="alert" style="border:1px solid #ddd; background:#fafafa; margin-bottom:12px;">
      <div>
        <strong>é¡ä¼¼åº¦:</strong>
        <span class="sim-badge {{ sim_cls }}">{{ similarity_percent|default(0) }}%</span>
        <span style="color:#666; font-size:12px;">ï¼ˆblue / yellow / redï¼‰</span>
      </div>

      {% if saved_article_id and (rewrite_depth|default(0) == 0) %}
        <form method="POST" style="margin-top:10px;">
          <input type="hidden" name="action" value="rewrite_once">
          <input type="hidden" name="brand" value="{{ brand }}">
          <input type="hidden" name="reference" value="{{ reference }}">
          <input type="hidden" name="source_article_id" value="{{ saved_article_id }}">
          <button type="submit">è¨€ã„æ›ãˆå†ç”Ÿæˆï¼ˆ1å›ï¼‰</button>
          <small style="color:#666; display:block; margin-top:6px;">
            â€»å¿…è¦ãªã¨ãã ã‘æŠ¼ã—ã¦ãã ã•ã„ï¼ˆæœ€å¤§1å›ï¼‰
          </small>
        </form>
      {% else %}
        <div style="color:#666; font-size:12px; margin-top:8px;">
          â€»ã“ã®æ–‡ç« ã¯è¨€ã„æ›ãˆæ¸ˆã¿ã®ãŸã‚ã€å†åº¦ã®è¨€ã„æ›ãˆã¯ã§ãã¾ã›ã‚“ï¼ˆæœ€å¤§1å›ï¼‰
        </div>
      {% endif %}    
    </div>

    <div class="form-group">
      <label for="generated_intro">ã€å•†å“ç´¹ä»‹æ–‡ã€‘ ({{ generated_intro_text|length }}æ–‡å­—)</label>
      <textarea id="generated_intro" readonly rows="10" style="font-family: monospace; white-space: pre-wrap; word-wrap: break-word;">{{ generated_intro_text }}</textarea>
      <button type="button" onclick="copyToClipboard('generated_intro')" style="margin-top: 5px;">ã‚³ãƒ”ãƒ¼</button>
    </div>

    <div class="form-group">
      <label for="generated_specs">ã€å•†å“ã‚¹ãƒšãƒƒã‚¯ã€‘ ({{ generated_specs_text|length }}æ–‡å­—)</label>
      <textarea id="generated_specs" readonly rows="10" style="font-family: monospace; white-space: pre-wrap; word-wrap: break-word;">{{ generated_specs_text }}</textarea>
      <button type="button" onclick="copyToClipboard('generated_specs')" style="margin-top: 5px;">ã‚³ãƒ”ãƒ¼</button>
    </div>

    <details style="margin-top:12px;">
      <summary>ãƒ‡ãƒãƒƒã‚°ï¼šURLæœ¬æ–‡ãŒå–å¾—ã§ãã¦ã„ã‚‹ã‹<span class="v0-collapsible-hint"></span></summary>
      <div style="font-size:12px; color:#444; margin-top:8px;">
        <div><strong>llm_client_file:</strong> {{ llm_client_file }}</div>
        <div><strong>raw_urls_debug:</strong> {{ raw_urls_debug }}</div>
        <div><strong>combined_reference_chars:</strong> {{ combined_reference_chars }}</div>
        <div><strong>preview:</strong> {{ combined_reference_preview }}</div>
        <div style="margin-top:8px;"><strong>per_url</strong></div>
        {% for d in reference_urls_debug %}
          <div style="margin-top:6px; padding:6px; border:1px solid #eee;">
            <div><strong>url:</strong> {{ d.url }}</div>
            <div>allowed={{ d.allowed }} fetch_ok={{ d.fetch_ok }} status={{ d.status }} ok={{ d.ok }} ref_hit={{ d.ref_hit }}</div>
            <div>method={{ d.method }} chars={{ d.chars }} filtered_reason={{ d.filtered_reason }}</div>
            <div>preview: {{ d.preview }}</div>
          </div>
        {% endfor %}
      </div>
    </details>
  {% endif %}
</section>

  {% if history %}
  <section class="v0-card v0-card-history">
    <h3><span class="v0-title-icon">ğŸ•˜</span>ç”Ÿæˆå±¥æ­´ï¼ˆç›´è¿‘{{ history|length }}ä»¶ï¼‰</h3>
    <div class="v0-history-list">

    {% for h in history %}
      <div class="v0-history-item">
        <div class="v0-history-head">
          <div class="v0-history-meta">
            <span class="v0-history-id">#{{ h.id }}</span>
            <span class="v0-history-date">{{ h.created_at }}</span>
          </div>
          {% set h_cls = (h.similarity_level or 'blue') %}
          <div class="v0-history-similarity">
            <span class="sim-badge {{ h_cls }}">é¡ä¼¼åº¦ {{ h.similarity_percent|default(0) }}%</span>
          </div>
        </div>

        <div class="v0-history-reference">
          <div class="v0-history-reference-url"><strong>å‚è€ƒURLæ¡ç”¨:</strong> {{ h.selected_reference_url or 'ï¼ˆãªã—ï¼‰' }}</div>
          <div class="v0-history-reference-reason"><strong>ç†ç”±:</strong> {{ h.selected_reference_reason or 'ï¼ˆãªã—ï¼‰' }}</div>
        </div>

        <details class="v0-history-details v0-history-intro">
          <summary>å•†å“ç´¹ä»‹æ–‡<span class="v0-collapsible-hint"></span></summary>
          <textarea id="hist_intro_{{ h.id }}" readonly rows="8">{{ h.intro_text }}</textarea>
          <button type="button" class="v0-history-copy-btn" onclick="copyToClipboard('hist_intro_{{ h.id }}')">ç´¹ä»‹æ–‡ã‚’ã‚³ãƒ”ãƒ¼</button>
        </details>

        <details class="v0-history-details v0-history-specs">
          <summary>å•†å“ã‚¹ãƒšãƒƒã‚¯<span class="v0-collapsible-hint"></span></summary>
          <textarea id="hist_specs_{{ h.id }}" readonly rows="8">{{ h.specs_text }}</textarea>
          <button type="button" class="v0-history-copy-btn" onclick="copyToClipboard('hist_specs_{{ h.id }}')">ã‚¹ãƒšãƒƒã‚¯ã‚’ã‚³ãƒ”ãƒ¼</button>
        </details>

        {% if (h.rewrite_depth|default(0) == 0) and ((plan_mode == 'unlimited') or (monthly_remaining|default(0) > 0)) %}
          <form method="POST" class="v0-history-rewrite-form">
            <input type="hidden" name="action" value="rewrite_once">
            <input type="hidden" name="brand" value="{{ brand }}">
            <input type="hidden" name="reference" value="{{ reference }}">
            <input type="hidden" name="source_article_id" value="{{ h.id }}">
            <button type="submit" class="v0-history-rewrite-btn" onclick="this.disabled=true; this.form.submit();">ã“ã®å±¥æ­´ã‚’è¨€ã„æ›ãˆå†ç”Ÿæˆï¼ˆ1å›ï¼‰</button>
          </form>
        {% elif (h.rewrite_depth|default(0) != 0) %}
          <div class="v0-history-note">
            â€»ã“ã®å±¥æ­´ã¯è¨€ã„æ›ãˆæ¸ˆã¿ã®ãŸã‚ã€å†åº¦ã®è¨€ã„æ›ãˆã¯ã§ãã¾ã›ã‚“ï¼ˆæœ€å¤§1å›ï¼‰
          </div>
        {% else %}
          <div class="v0-history-note v0-history-note-error">
            â€»ä»Šæœˆã®ç”Ÿæˆä¸Šé™ã«é”ã—ã¦ã„ã‚‹ãŸã‚ã€è¨€ã„æ›ãˆã§ãã¾ã›ã‚“
          </div>
        {% endif %}
      </div>
    {% endfor %}
    </div>
  </section>
  {% endif %}

{% endif %}

{% if recent_generations %}
  <section class="v0-card v0-card-recent">
    <h2 style="margin:0 0 8px 0;"><span class="v0-title-icon">ğŸ§¾</span>ç›´è¿‘ã®ç”Ÿæˆ10ä»¶</h2>
    <div class="v0-recent-list">
    {% for g in recent_generations %}
      <div class="v0-recent-row">
        <div class="v0-recent-main">
          <span class="v0-recent-rank">{{ loop.index }}</span>
          <div class="v0-recent-title">
            <a class="v0-recent-link" href="{{ url_for('staff_search', brand=g.brand, reference=g.reference) }}">
              <span class="v0-recent-brand">{{ g.brand }}</span>
              <span class="v0-recent-divider">/</span>
              <span class="v0-recent-ref">{{ g.reference }}</span>
            </a>
          </div>
        </div>
        <div class="v0-recent-meta">
          {% if g.elapsed_ms is not none %}
            <span class="v0-recent-duration">{{ '%.1f'|format(g.elapsed_ms / 1000) }}ç§’</span>
          {% endif %}
          <span class="v0-recent-date">{{ g.created_at_jst }}</span>
        </div>
      </div>
    {% endfor %}
    </div>
  </section>
{% endif %}

<section class="v0-card v0-card-usage">
  <h2 style="margin:0 0 8px 0;"><span class="v0-title-icon">ğŸ“Š</span>åˆ©ç”¨çŠ¶æ³</h2>
  <div><strong>ãƒ—ãƒ©ãƒ³:</strong> {{ plan_mode }}</div>
  <div><strong>å¯¾è±¡æœˆ:</strong> {{ month_key }}</div>
  {% if plan_mode == 'unlimited' %}
    <div><strong>ä»Šæœˆã®ç”Ÿæˆå›æ•°:</strong> ç„¡åˆ¶é™</div>
    <div><strong>æ®‹ã‚Š:</strong> ç„¡åˆ¶é™</div>
  {% else %}
    <div><strong>ä»Šæœˆã®ç”Ÿæˆå›æ•°:</strong> {{ monthly_used }} / {{ monthly_limit }}</div>
    <div><strong>æ®‹ã‚Š:</strong> {{ monthly_remaining }}</div>
  {% endif %}
</section>

<script>
function copyToClipboard(elementId) {
  const el = document.getElementById(elementId);
  if (!el) return;
  el.select();
  el.setSelectionRange(0, 999999);
  document.execCommand('copy');
  alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
}
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const brandSelect = document.getElementById('brand');
  const referenceInput = document.getElementById('reference');
  const referenceList = document.getElementById('reference_list');
  const refCount = document.getElementById('ref_count');
  const refLoading = document.getElementById('ref_loading');

  if (!brandSelect || !referenceInput || !referenceList || !refCount || !refLoading) {
    return;
  }

  const refCache = new Map();
  let requestId = 0;

  function clearOptions() {
    referenceList.innerHTML = '';
  }

  function applyOptions(items) {
    clearOptions();
    for (const ref of items) {
      const option = document.createElement('option');
      option.value = ref;
      referenceList.appendChild(option);
    }
  }

  function setIdleState() {
    referenceInput.disabled = false;
    refLoading.style.display = 'none';
  }

  async function updateReferences() {
    const brand = (brandSelect.value || '').trim();
    const currentRequest = ++requestId;

    if (!brand) {
      clearOptions();
      refCount.textContent = 'ç™»éŒ²æ•°: 0ä»¶';
      setIdleState();
      return;
    }

    if (refCache.has(brand)) {
      const cached = refCache.get(brand);
      applyOptions(cached.items);
      refCount.textContent = `ç™»éŒ²æ•°: ${cached.count}ä»¶`;
      setIdleState();
      return;
    }

    referenceInput.disabled = true;
    refLoading.style.display = 'inline';
    refCount.textContent = 'ç™»éŒ²æ•°: èª­ã¿è¾¼ã¿ä¸­â€¦';

    try {
      const res = await fetch(`/staff/references?brand=${encodeURIComponent(brand)}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      if (currentRequest !== requestId) return;

      const items = Array.isArray(data.items) ? data.items : [];
      const count = Number.isFinite(Number(data.count)) ? Number(data.count) : items.length;
      refCache.set(brand, { count, items });
      applyOptions(items);
      refCount.textContent = `ç™»éŒ²æ•°: ${count}ä»¶`;
      setIdleState();
    } catch (_e) {
      if (currentRequest !== requestId) return;
      clearOptions();
      refCount.textContent = 'ç™»éŒ²æ•°: å–å¾—å¤±æ•—';
      setIdleState();
    }
  }

  brandSelect.addEventListener('change', updateReferences);

  if ((brandSelect.value || '').trim()) {
    updateReferences();
  } else {
    clearOptions();
    refCount.textContent = 'ç™»éŒ²æ•°: 0ä»¶';
  }
});
</script>

</div>
{% endblock %}
