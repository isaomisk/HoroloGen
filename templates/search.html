{% extends "base.html" %}

{% block title %}Staff: 検索・オーバーライド - HoroloGen{% endblock %}

{% block content %}
<h1>Staff: 検索・オーバーライド</h1>

<form method="POST" style="margin-bottom: 30px;">
  <input type="hidden" name="action" value="search">
  <div class="form-group">
    <label for="brand">ブランド</label>
    <select id="brand" name="brand" required>
      <option value="">選択してください</option>
      {% for b in brands %}
      <option value="{{ b }}" {% if brand == b %}selected{% endif %}>{{ b }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="form-group">
    <div id="ref_count">登録数: -</div>
    <label for="reference">リファレンス</label>
    <input type="text" id="reference" name="reference" list="reference_list" value="{{ reference or '' }}" required>
    <datalist id="reference_list"></datalist>
    <span id="ref_loading" style="display:none;">読み込み中…</span>
  </div>

  <button type="submit">検索</button>
</form>

{% if warnings %}
  {% for warning in warnings %}
  <div class="alert alert-warning">{{ warning }}</div>
  {% endfor %}
{% endif %}

{% if override_warning %}
  <div class="alert alert-warning">
    <strong>警告:</strong> {{ override_warning }}
    {% if import_conflict_warning %}
    <br><strong>追加警告:</strong> {{ import_conflict_warning }}
    {% endif %}
  </div>
{% endif %}

{% if override %}
<div style="margin-bottom: 20px;">
  <form method="POST" style="display: inline;">
    <input type="hidden" name="action" value="delete_override">
    <input type="hidden" name="brand" value="{{ brand }}">
    <input type="hidden" name="reference" value="{{ reference }}">
    <button type="submit" class="btn btn-danger" onclick="return confirm('オーバーライドを解除してマスタに戻しますか？')">
      オーバーライド解除（マスタに戻す）
    </button>
  </form>
</div>
{% endif %}

{% if canonical %}
  <h2>正規仕様（Canonical Specs）</h2>
  <div class="specs-grid">
    {% for field, value in canonical.items() %}
    <div class="spec-card {% if field in overridden_fields %}override-field{% endif %}">
      <div class="spec-label">
        {{ field }}
        {% if field in overridden_fields %}
        <span class="override-badge">オーバーライド</span>
        {% endif %}
      </div>
      <div class="spec-value">{{ value or '(空)' }}</div>
    </div>
    {% endfor %}
  </div>

  <h2>記事生成（ダミー）</h2>
  <div class="alert" style="border:1px solid #ddd; background:#fafafa; margin-bottom:12px;">
    <div><strong>プラン:</strong> {{ plan_mode }}</div>
    <div><strong>対象月:</strong> {{ month_key }}</div>
    {% if plan_mode == 'unlimited' %}
      <div><strong>生成回数:</strong> 無制限</div>
    {% else %}
      <div><strong>今月の生成回数:</strong> {{ monthly_used }} / {{ monthly_limit }}</div>
      <div><strong>残り:</strong> {{ monthly_remaining }}</div>
    {% endif %}
  </div>

  {% set locked = (generated_intro_text or generated_specs_text) %}
  <form method="POST" style="margin-bottom: 30px;">
    <input type="hidden" name="action" value="generate_dummy">
    <input type="hidden" name="brand" value="{{ brand }}">
    <input type="hidden" name="reference" value="{{ reference }}">
    {% if locked %}
      <input type="hidden" name="tone" value="{{ generation_tone if generation_tone else 'casual_friendly' }}">
      <input type="hidden" name="include_brand_profile" value="{{ 'on' if generation_include_brand_profile else 'off' }}">
      <input type="hidden" name="include_wearing_scenes" value="{{ 'on' if generation_include_wearing_scenes else 'off' }}">
      <input type="hidden" name="reference_url_1" value="{{ generation_reference_urls[0] if generation_reference_urls and generation_reference_urls|length > 0 else '' }}">
      <input type="hidden" name="reference_url_2" value="{{ generation_reference_urls[1] if generation_reference_urls and generation_reference_urls|length > 1 else '' }}">
      <input type="hidden" name="reference_url_3" value="{{ generation_reference_urls[2] if generation_reference_urls and generation_reference_urls|length > 2 else '' }}">
    {% endif %}

    <div class="form-group">
      <label for="tone">トーン</label>
      <select id="tone" name="tone" required {% if locked %}disabled{% endif %}>
        <option value="luxury" {% if generation_tone == 'luxury' %}selected{% endif %}>フォーマル・権威型（luxury）</option>
        <option value="casual_friendly" {% if generation_tone == 'casual_friendly' or not generation_tone %}selected{% endif %}>カジュアル・親しみ型（casual_friendly）</option>
        <option value="magazine_story" {% if generation_tone == 'magazine_story' %}selected{% endif %}>ストーリー型（magazine_story）</option>
        <option value="practical" {% if generation_tone == 'practical' %}selected{% endif %}>実用・標準（practical）</option>
      </select>
    </div>

    <div class="form-group">
      <label>
        <input type="checkbox" name="include_brand_profile" {% if generation_include_brand_profile %}checked{% endif %} {% if locked %}disabled{% endif %}>
        ブランドプロフィールを含める
      </label>
    </div>

    <div class="form-group">
      <label>
        <input type="checkbox" name="include_wearing_scenes" {% if generation_include_wearing_scenes %}checked{% endif %} {% if locked %}disabled{% endif %}>
        装着シーンを含める
      </label>
    </div>

    <div class="form-group">
      <label>参考URL（任意・最大3本）</label>

      <input
        type="url"
        name="reference_url_1"
        value="{{ generation_reference_urls[0] if generation_reference_urls and generation_reference_urls|length > 0 else '' }}"
        placeholder="参考URL 1（推奨）: https://..."
        style="width: 100%; margin-bottom: 8px;"
        {% if locked %}disabled{% endif %}
      >

      <input
        type="url"
        name="reference_url_2"
        value="{{ generation_reference_urls[1] if generation_reference_urls and generation_reference_urls|length > 1 else '' }}"
        placeholder="参考URL 2（任意）: https://..."
        style="width: 100%; margin-bottom: 8px;"
        {% if locked %}disabled{% endif %}
      >

      <input
        type="url"
        name="reference_url_3"
        value="{{ generation_reference_urls[2] if generation_reference_urls and generation_reference_urls|length > 2 else '' }}"
        placeholder="参考URL 3（任意）: https://..."
        style="width: 100%;"
        {% if locked %}disabled{% endif %}
      >

      <small style="color:#666;">
        公式 / 正規代理店 / 許可メディアなど、信頼できるページを最大3本まで貼れます（ホワイトリスト外は取得されません）
      </small>
    </div>

    {% set quota_ok = (plan_mode == 'unlimited') or (monthly_remaining|default(0) > 0) %}
    <button type="submit" {% if not quota_ok %}disabled{% endif %}>記事生成（ダミー）</button>
    {% if not quota_ok %}
      <div style="color:#c00; font-size:12px; margin-top:6px;">※今月の生成上限に達しています</div>
    {% endif %}
  </form>

  {% if generated_intro_text or generated_specs_text %}
    <h3>生成結果</h3>

    {% if selected_reference_url %}
      <div class="alert alert-info" style="margin-bottom: 12px;">
        <div><strong>参考URL採用:</strong> {{ selected_reference_url }}</div>
        {% if selected_reference_reason %}
        <div><strong>理由:</strong> {{ selected_reference_reason }}</div>
        {% endif %}
      </div>
    {% endif %}

    {% set sim_cls = similarity_level|default('blue') %}
    <div class="alert" style="border:1px solid #ddd; background:#fafafa; margin-bottom:12px;">
      <div>
        <strong>類似度:</strong>
        <span class="sim-badge {{ sim_cls }}">{{ similarity_percent|default(0) }}%</span>
        <span style="color:#666; font-size:12px;">（blue / yellow / red）</span>
      </div>

      {% if saved_article_id and (rewrite_depth|default(0) == 0) %}
        <form method="POST" style="margin-top:10px;">
          <input type="hidden" name="action" value="rewrite_once">
          <input type="hidden" name="brand" value="{{ brand }}">
          <input type="hidden" name="reference" value="{{ reference }}">
          <input type="hidden" name="source_article_id" value="{{ saved_article_id }}">
          <button type="submit">言い換え再生成（1回）</button>
          <small style="color:#666; display:block; margin-top:6px;">
            ※必要なときだけ押してください（最大1回）
          </small>
        </form>
      {% else %}
        <div style="color:#666; font-size:12px; margin-top:8px;">
          ※この文章は言い換え済みのため、再度の言い換えはできません（最大1回）
        </div>
      {% endif %}    
    </div>

    <div class="form-group">
      <label for="generated_intro">【商品紹介文】 ({{ generated_intro_text|length }}文字)</label>
      <textarea id="generated_intro" readonly rows="10" style="font-family: monospace; white-space: pre-wrap; word-wrap: break-word;">{{ generated_intro_text }}</textarea>
      <button type="button" onclick="copyToClipboard('generated_intro')" style="margin-top: 5px;">コピー</button>
    </div>

    <div class="form-group">
      <label for="generated_specs">【商品スペック】 ({{ generated_specs_text|length }}文字)</label>
      <textarea id="generated_specs" readonly rows="10" style="font-family: monospace; white-space: pre-wrap; word-wrap: break-word;">{{ generated_specs_text }}</textarea>
      <button type="button" onclick="copyToClipboard('generated_specs')" style="margin-top: 5px;">コピー</button>
    </div>

    <details style="margin-top:12px;">
      <summary>デバッグ：URL本文が取得できているか（開く）</summary>
      <div style="font-size:12px; color:#444; margin-top:8px;">
        <div><strong>llm_client_file:</strong> {{ llm_client_file }}</div>
        <div><strong>raw_urls_debug:</strong> {{ raw_urls_debug }}</div>
        <div><strong>combined_reference_chars:</strong> {{ combined_reference_chars }}</div>
        <div><strong>preview:</strong> {{ combined_reference_preview }}</div>
        <div style="margin-top:8px;"><strong>per_url</strong></div>
        {% for d in reference_urls_debug %}
          <div style="margin-top:6px; padding:6px; border:1px solid #eee;">
            <div><strong>url:</strong> {{ d.url }}</div>
            <div>allowed={{ d.allowed }} fetch_ok={{ d.fetch_ok }} status={{ d.status }} ok={{ d.ok }} ref_hit={{ d.ref_hit }}</div>
            <div>method={{ d.method }} chars={{ d.chars }} filtered_reason={{ d.filtered_reason }}</div>
            <div>preview: {{ d.preview }}</div>
          </div>
        {% endfor %}
      </div>
    </details>
  {% endif %}

  {% if history %}
    <hr>
    <h3>生成履歴（直近{{ history|length }}件）</h3>

    {% for h in history %}
      <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd;">
        <div style="color:#666; font-size: 12px;">
          #{{ h.id }} / {{ h.created_at }}
        </div>

        {% set h_cls = (h.similarity_level or 'blue') %}
        <div style="margin-top:6px; font-size: 12px; color:#444;">
          <strong>類似度:</strong>
          <span class="sim-badge {{ h_cls }}">{{ h.similarity_percent|default(0) }}%</span>
        </div>

        {% if h.selected_reference_url %}
          <div style="margin-top:6px; font-size: 12px; color:#444;">
            <div><strong>参考URL採用:</strong> {{ h.selected_reference_url }}</div>
            {% if h.selected_reference_reason %}
            <div><strong>理由:</strong> {{ h.selected_reference_reason }}</div>
            {% endif %}
          </div>
        {% endif %}

        <details style="margin-top:8px;">
          <summary>商品紹介文</summary>
          <textarea id="hist_intro_{{ h.id }}" readonly rows="8" style="width:100%; font-family: monospace; white-space: pre-wrap;">{{ h.intro_text }}</textarea>
          <button type="button" onclick="copyToClipboard('hist_intro_{{ h.id }}')" style="margin-top: 6px;">紹介文をコピー</button>
        </details>

        <details style="margin-top:8px;">
          <summary>商品スペック</summary>
          <textarea id="hist_specs_{{ h.id }}" readonly rows="8" style="width:100%; font-family: monospace; white-space: pre-wrap;">{{ h.specs_text }}</textarea>
          <button type="button" onclick="copyToClipboard('hist_specs_{{ h.id }}')" style="margin-top: 6px;">スペックをコピー</button>
        </details>

        {% if (h.rewrite_depth|default(0) == 0) and ((plan_mode == 'unlimited') or (monthly_remaining|default(0) > 0)) %}
          <form method="POST" style="margin-top: 10px;">
            <input type="hidden" name="action" value="rewrite_once">
            <input type="hidden" name="brand" value="{{ brand }}">
            <input type="hidden" name="reference" value="{{ reference }}">
            <input type="hidden" name="source_article_id" value="{{ h.id }}">
            <button type="submit" onclick="this.disabled=true; this.form.submit();">この履歴を言い換え再生成（1回）</button>
          </form>
        {% elif (h.rewrite_depth|default(0) != 0) %}
          <div style="color:#666; font-size:12px; margin-top:8px;">
            ※この履歴は言い換え済みのため、再度の言い換えはできません（最大1回）
          </div>
        {% else %}
          <div style="color:#c00; font-size:12px; margin-top:8px;">
            ※今月の生成上限に達しているため、言い換えできません
          </div>
        {% endif %}
      </div>
    {% endfor %}
  {% endif %}

  <h2>オーバーライド編集</h2>
  <form method="POST">
    <input type="hidden" name="action" value="save_override">
    <input type="hidden" name="brand" value="{{ brand }}">
    <input type="hidden" name="reference" value="{{ reference }}">

    <div class="specs-grid">
      <div class="form-group">
        <label for="price_jpy">価格 (JPY)</label>
        <input type="text" id="price_jpy" name="price_jpy" value="{{ override.price_jpy if override else '' }}" placeholder="{{ master.price_jpy if master else '' }}">
      </div>

      <div class="form-group">
        <label for="case_size_mm">ケースサイズ (mm)</label>
        <input type="text" id="case_size_mm" name="case_size_mm" value="{{ override.case_size_mm if override else '' }}" placeholder="{{ master.case_size_mm if master else '' }}">
      </div>

      <div class="form-group">
        <label for="movement">ムーブメント</label>
        <select id="movement" name="movement">
          <option value="">選択してください</option>
          <option value="automatic" {% if override and override.movement == 'automatic' %}selected{% endif %}>automatic</option>
          <option value="manual" {% if override and override.movement == 'manual' %}selected{% endif %}>manual</option>
          <option value="quartz" {% if override and override.movement == 'quartz' %}selected{% endif %}>quartz</option>
          <option value="Spring Drive automatic" {% if override and override.movement == 'Spring Drive automatic' %}selected{% endif %}>Spring Drive automatic</option>
          <option value="Manual winding" {% if override and override.movement == 'Manual winding' %}selected{% endif %}>Manual winding</option>
        </select>
        {% if master and master.movement %}
        <small style="color: #666;">マスタ値: {{ master.movement }}</small>
        {% endif %}
      </div>

      <div class="form-group">
        <label for="case_material">ケース材質</label>
        <input type="text" id="case_material" name="case_material" value="{{ override.case_material if override else '' }}" placeholder="{{ master.case_material if master else '' }}">
      </div>

      <div class="form-group">
        <label for="bracelet_strap">ブレスレット/ストラップ</label>
        <select id="bracelet_strap" name="bracelet_strap">
          <option value="">選択してください</option>
          <option value="bracelet" {% if override and override.bracelet_strap == 'bracelet' %}selected{% endif %}>bracelet</option>
          <option value="strap" {% if override and override.bracelet_strap == 'strap' %}selected{% endif %}>strap</option>
        </select>
        {% if master and master.bracelet_strap %}
        <small style="color: #666;">マスタ値: {{ master.bracelet_strap }}</small>
        {% endif %}
      </div>

      <div class="form-group">
        <label for="dial_color">ダイアルカラー</label>
        <input type="text" id="dial_color" name="dial_color" value="{{ override.dial_color if override else '' }}" placeholder="{{ master.dial_color if master else '' }}">
      </div>

      <div class="form-group">
        <label for="water_resistance_m">耐水性能 (m)</label>
        <input type="text" id="water_resistance_m" name="water_resistance_m" value="{{ override.water_resistance_m if override else '' }}" placeholder="{{ master.water_resistance_m if master else '' }}">
      </div>

      <div class="form-group">
        <label for="buckle">バックル</label>
        <select id="buckle" name="buckle">
          <option value="">選択してください</option>
          <option value="pin" {% if override and override.buckle == 'pin' %}selected{% endif %}>pin</option>
          <option value="D" {% if override and override.buckle == 'D' %}selected{% endif %}>D</option>
        </select>
        {% if master and master.buckle %}
        <small style="color: #666;">マスタ値: {{ master.buckle }}</small>
        {% endif %}
      </div>

      <div class="form-group">
        <label for="warranty_years">保証期間 (年)</label>
        <input type="text" id="warranty_years" name="warranty_years" value="{{ override.warranty_years if override else '' }}" placeholder="{{ master.warranty_years if master else '' }}">
      </div>

      <div class="form-group">
        <label for="collection">コレクション</label>
        <input type="text" id="collection" name="collection" value="{{ override.collection if override else '' }}" placeholder="{{ master.collection if master else '' }}">
      </div>

      <div class="form-group">
        <label for="movement_caliber">ムーブメントキャリバー</label>
        <input type="text" id="movement_caliber" name="movement_caliber" value="{{ override.movement_caliber if override else '' }}" placeholder="{{ master.movement_caliber if master else '' }}">
      </div>

      <div class="form-group">
        <label for="case_thickness_mm">ケース厚さ (mm)</label>
        <input type="text" id="case_thickness_mm" name="case_thickness_mm" value="{{ override.case_thickness_mm if override else '' }}" placeholder="{{ master.case_thickness_mm if master else '' }}">
      </div>

      <div class="form-group">
        <label for="lug_width_mm">ラグ幅 (mm)</label>
        <input type="text" id="lug_width_mm" name="lug_width_mm" value="{{ override.lug_width_mm if override else '' }}" placeholder="{{ master.lug_width_mm if master else '' }}">
      </div>

      <div class="form-group" style="grid-column: 1 / -1;">
        <label for="remarks">備考</label>
        <textarea id="remarks" name="remarks" rows="3">{{ override.remarks if override else '' }}</textarea>
        {% if master and master.remarks %}
        <small style="color: #666;">マスタ値: {{ master.remarks }}</small>
        {% endif %}
      </div>
    </div>

    <div class="form-group" style="grid-column: 1 / -1; margin-top: 15px;">
      <label for="editor_note">スタッフ追加入力（必ず文章に反映されます）</label>
      <textarea
        id="editor_note"
        name="editor_note"
        rows="4"
        placeholder="接客での実体験・商品の魅力・エピソードなどを自由に記載してください。">{{ override.editor_note if override and override.editor_note else '' }}</textarea>

      <small style="color:#666;">
        ※ここに入力した内容は、商品紹介文（intro）に必ず反映されます。
      </small>
    </div>

    <button type="submit" style="margin-top: 20px;">オーバーライドを保存</button>
  </form>
{% endif %}

<script>
function copyToClipboard(elementId) {
  const el = document.getElementById(elementId);
  if (!el) return;
  el.select();
  el.setSelectionRange(0, 999999);
  document.execCommand('copy');
  alert('コピーしました');
}
</script>

{% endblock %}
