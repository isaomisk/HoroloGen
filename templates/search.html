{% extends "base.html" %}

{% block title %}Staff: 検索・オーバーライド - HoroloGen{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='staff_search_v0.css') }}">
{% endblock %}

{% block content %}
<div class="staff-search-v0">
<div class="v0-page-head">
  <div class="v0-page-head-top">
    <h1>検索・記事作成</h1>
    <div class="v0-dual-clock" aria-label="現在時刻">
      <div class="v0-analog-clock" aria-hidden="true">
        <div class="v0-analog-face">
          <span class="v0-hour-hand" id="clock_hour_hand"></span>
          <span class="v0-minute-hand" id="clock_minute_hand"></span>
          <span class="v0-second-hand" id="clock_second_hand"></span>
          <span class="v0-clock-center"></span>
        </div>
      </div>
      <div class="v0-digital-clock">
        <div class="v0-digital-time" id="clock_time">--:--:--</div>
        <div class="v0-digital-date" id="clock_date">----/--/-- ---</div>
      </div>
    </div>
  </div>
  <p>ブランドとリファレンスを指定して、仕様確認・記事の作成を行えます。</p>
</div>

{% if is_admin %}
<section class="v0-card v0-card-search">
  <h2><span class="v0-title-icon"><i data-lucide="users"></i></span>Staff表示テナント</h2>
  <form method="GET" class="v0-search-form">
    <div class="form-group v0-field">
      <label for="tenant_id">対象テナント</label>
      <select id="tenant_id" name="tenant_id">
        <option value="">選択してください</option>
        {% for t in admin_tenant_options %}
        <option value="{{ t.id }}" {% if staff_tenant_id == t.id %}selected{% endif %}>{{ t.name }} (ID: {{ t.id }})</option>
        {% endfor %}
      </select>
    </div>
    <button type="submit" class="v0-primary-btn">適用</button>
  </form>
</section>
{% endif %}

{% if staff_tenant_missing %}
<div class="alert alert-warning">テナントを選択してください。</div>
{% endif %}

{% if not staff_tenant_missing %}
<section class="v0-card v0-card-search">
<h2><span class="v0-title-icon"><i data-lucide="search"></i></span>検索</h2>
<form method="POST" class="v0-search-form">
  <input type="hidden" name="action" value="search">
  <div class="form-group v0-field">
    <label for="brand">ブランド</label>
    <select id="brand" name="brand" data-references-url="{{ url_for('staff_references') }}" required>
      <option value="">選択してください</option>
      {% for b in brands %}
      <option value="{{ b }}" {% if brand == b %}selected{% endif %}>{{ b }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="form-group v0-field">
    <label for="reference" style="display:flex; align-items:baseline; justify-content:space-between; gap:10px; margin-bottom:4px;">
      <span>リファレンス</span>
      <span id="ref_count" class="v0-muted">登録数: {% if reference_registration_count is none %}-{% else %}{{ reference_registration_count }}件{% endif %}</span>
    </label>
    <div class="v0-reference-wrap">
      <input type="text" id="reference" name="reference" value="{{ reference or '' }}" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" required>
      <div id="reference_suggestions" class="v0-reference-suggestions" hidden></div>
    </div>
    <span id="ref_loading" class="v0-loading" style="display:none;">読み込み中…</span>
  </div>

  <button type="submit" class="v0-primary-btn">検索</button>
</form>
</section>

{% if warnings %}
  {% for warning in warnings %}
  <div class="alert alert-warning">{{ warning }}</div>
  {% endfor %}
{% endif %}

{% if override_warning %}
  <div class="alert alert-warning">
    <strong>警告:</strong> {{ override_warning }}
    {% if import_conflict_warning %}
    <br><strong>追加警告:</strong> {{ import_conflict_warning }}
    {% endif %}
  </div>
{% endif %}

{% if canonical %}
<section class="v0-card v0-card-canonical">
  <details class="canonical-specs-collapsible">
    <summary><span class="v0-title-icon"><i data-lucide="settings"></i></span>商品スペック<span class="v0-canonical-count">{{ canonical|length }}項目</span><span class="v0-collapsible-hint"></span></summary>
    {% set ordered_fields = [
      ('brand', 'ブランド'),
      ('collection', 'コレクション'),
      ('reference', 'Ref.'),
      ('price_jpy', '価格 (JPY)'),
      ('dial_color', 'ダイアルカラー'),
      ('case_material', 'ケース材質'),
      ('case_size_mm', 'ケースサイズ (mm)'),
      ('case_thickness_mm', 'ケース厚さ (mm)'),
      ('lug_width_mm', 'ラグ幅 (mm)'),
      ('movement', 'ムーブメント'),
      ('movement_caliber', 'ムーブメントキャリバー'),
      ('bracelet_strap', 'ブレスレット/ストラップ'),
      ('buckle', 'バックル'),
      ('water_resistance_m', '耐水性能 (m)'),
      ('warranty_years', '保証期間 (年)'),
      ('remarks', '備考')
    ] %}
    <div class="specs-grid">
      {% for field, label in ordered_fields %}
      {% if field == 'brand' %}
      {% set value = brand %}
      {% elif field == 'reference' %}
      {% set value = reference %}
      {% else %}
      {% set value = canonical.get(field, '') %}
      {% endif %}
      <div class="spec-card {% if field in overridden_fields %}override-field{% endif %}">
        <div class="spec-label">
          {{ label }}
          {% if field in overridden_fields %}
          <span class="override-badge">オーバーライド</span>
          {% endif %}
        </div>
        <div class="spec-value">{{ value or '(空)' }}</div>
      </div>
      {% endfor %}
    </div>
    <form method="POST" id="save_override_form">
      <input type="hidden" name="action" value="save_override">
      <input type="hidden" name="brand" value="{{ brand }}">
      <input type="hidden" name="reference" value="{{ reference }}">
      <details class="form-group v0-override-details">
        <summary>スペック編集<span class="v0-collapsible-hint"></span></summary>
        <div class="specs-grid v0-override-grid">
      <div class="form-group">
        <label for="price_jpy">価格 (JPY)</label>
        <input type="text" id="price_jpy" name="price_jpy" value="{{ override.price_jpy if override else '' }}" placeholder="{{ master.price_jpy if master else '' }}">
      </div>

      <div class="form-group">
        <label for="case_size_mm">ケースサイズ (mm)</label>
        <input type="text" id="case_size_mm" name="case_size_mm" value="{{ override.case_size_mm if override else '' }}" placeholder="{{ master.case_size_mm if master else '' }}">
      </div>

      <div class="form-group">
        <label for="movement">ムーブメント</label>
        <select id="movement" name="movement">
          <option value="">選択してください</option>
          <option value="automatic" {% if override and override.movement == 'automatic' %}selected{% endif %}>automatic</option>
          <option value="manual" {% if override and override.movement == 'manual' %}selected{% endif %}>manual</option>
          <option value="quartz" {% if override and override.movement == 'quartz' %}selected{% endif %}>quartz</option>
          <option value="Spring Drive automatic" {% if override and override.movement == 'Spring Drive automatic' %}selected{% endif %}>Spring Drive automatic</option>
          <option value="Manual winding" {% if override and override.movement == 'Manual winding' %}selected{% endif %}>Manual winding</option>
        </select>
        {% if master and master.movement %}
        <small style="color: #666;">マスタ値: {{ master.movement }}</small>
        {% endif %}
      </div>

      <div class="form-group">
        <label for="case_material">ケース材質</label>
        <input type="text" id="case_material" name="case_material" value="{{ override.case_material if override else '' }}" placeholder="{{ master.case_material if master else '' }}">
      </div>

      <div class="form-group">
        <label for="bracelet_strap">ブレスレット/ストラップ</label>
        <select id="bracelet_strap" name="bracelet_strap">
          <option value="">選択してください</option>
          <option value="bracelet" {% if override and override.bracelet_strap == 'bracelet' %}selected{% endif %}>bracelet</option>
          <option value="strap" {% if override and override.bracelet_strap == 'strap' %}selected{% endif %}>strap</option>
        </select>
        {% if master and master.bracelet_strap %}
        <small style="color: #666;">マスタ値: {{ master.bracelet_strap }}</small>
        {% endif %}
      </div>

      <div class="form-group">
        <label for="dial_color">ダイアルカラー</label>
        <input type="text" id="dial_color" name="dial_color" value="{{ override.dial_color if override else '' }}" placeholder="{{ master.dial_color if master else '' }}">
      </div>

      <div class="form-group">
        <label for="water_resistance_m">耐水性能 (m)</label>
        <input type="text" id="water_resistance_m" name="water_resistance_m" value="{{ override.water_resistance_m if override else '' }}" placeholder="{{ master.water_resistance_m if master else '' }}">
      </div>

      <div class="form-group">
        <label for="buckle">バックル</label>
        <select id="buckle" name="buckle">
          <option value="">選択してください</option>
          <option value="pin" {% if override and override.buckle == 'pin' %}selected{% endif %}>pin</option>
          <option value="D" {% if override and override.buckle == 'D' %}selected{% endif %}>D</option>
        </select>
        {% if master and master.buckle %}
        <small style="color: #666;">マスタ値: {{ master.buckle }}</small>
        {% endif %}
      </div>

      <div class="form-group">
        <label for="warranty_years">保証期間 (年)</label>
        <input type="text" id="warranty_years" name="warranty_years" value="{{ override.warranty_years if override else '' }}" placeholder="{{ master.warranty_years if master else '' }}">
      </div>

      <div class="form-group">
        <label for="collection">コレクション</label>
        <input type="text" id="collection" name="collection" value="{{ override.collection if override else '' }}" placeholder="{{ master.collection if master else '' }}">
      </div>

      <div class="form-group">
        <label for="movement_caliber">ムーブメントキャリバー</label>
        <input type="text" id="movement_caliber" name="movement_caliber" value="{{ override.movement_caliber if override else '' }}" placeholder="{{ master.movement_caliber if master else '' }}">
      </div>

      <div class="form-group">
        <label for="case_thickness_mm">ケース厚さ (mm)</label>
        <input type="text" id="case_thickness_mm" name="case_thickness_mm" value="{{ override.case_thickness_mm if override else '' }}" placeholder="{{ master.case_thickness_mm if master else '' }}">
      </div>

      <div class="form-group">
        <label for="lug_width_mm">ラグ幅 (mm)</label>
        <input type="text" id="lug_width_mm" name="lug_width_mm" value="{{ override.lug_width_mm if override else '' }}" placeholder="{{ master.lug_width_mm if master else '' }}">
      </div>

      <div class="form-group" style="grid-column: 1 / -1;">
        <label for="remarks">備考</label>
        <textarea id="remarks" name="remarks" rows="3">{{ override.remarks if override else '' }}</textarea>
        {% if master and master.remarks %}
        <small style="color: #666;">マスタ値: {{ master.remarks }}</small>
        {% endif %}
      </div>
        </div>
      </details>
    </form>
    <form method="POST" id="delete_override_form">
      <input type="hidden" name="action" value="delete_override">
      <input type="hidden" name="brand" value="{{ brand }}">
      <input type="hidden" name="reference" value="{{ reference }}">
    </form>
    <div class="v0-spec-actions">
      <button type="submit" form="delete_override_form" class="btn btn-danger v0-override-delete-btn js-double-confirm-delete">スペック修正を解除</button>
      <button type="submit" form="save_override_form" class="v0-override-save-btn">オーバーライドを保存</button>
    </div>
  </details>
</section>

<section class="v0-card">
  <h2><span class="v0-title-icon"><i data-lucide="book-open"></i></span>スタッフ追加入力</h2>
  <div class="form-group" style="margin-top: 0;">
    <textarea
      id="staff_additional_input"
      rows="4"
      placeholder="商品の印象や魅力・接客での実体験やエピソードなど自由に記載してください">{{ staff_additional_input or '' }}</textarea>
    <small style="color:#666;">
      ※内容を保存し作成文へ自然に反映します
    </small>
    <div id="staff_additional_input_required_note" style="display:none; color:#b42318; font-size:12px; margin-top:6px;">
      スタッフ追加入力は必須です
    </div>
    <input type="hidden" id="saved_staff_additional_input" value="{{ staff_additional_input or '' }}">
  </div>
</section>

<section class="v0-card v0-card-article">
  <h2><span class="v0-title-icon"><i data-lucide="sparkles"></i></span>記事作成</h2>
  <div class="v0-article-meta">
    <div class="v0-article-meta-left">プラン: {{ plan_mode }} / 対象月: {{ month_key }}</div>
    {% if plan_mode == 'unlimited' %}
      <div class="v0-article-meta-right">残り 無制限</div>
    {% else %}
      <div class="v0-article-meta-right">残り {{ monthly_remaining }} / {{ monthly_limit }}</div>
    {% endif %}
  </div>

  {% set locked = (generated_intro_text or generated_specs_text) %}
  <form method="POST" class="v0-article-form">
    <input type="hidden" name="action" value="generate_dummy">
    <input type="hidden" name="brand" value="{{ brand }}">
    <input type="hidden" name="reference" value="{{ reference }}">
    <input type="hidden" name="staff_additional_input" value="{{ staff_additional_input or '' }}">
    {% if locked %}
      <input type="hidden" name="tone" value="{{ generation_tone if generation_tone else 'casual_friendly' }}">
      <input type="hidden" name="include_brand_profile" value="{{ 'on' if generation_include_brand_profile else 'off' }}">
      <input type="hidden" name="include_wearing_scenes" value="{{ 'on' if generation_include_wearing_scenes else 'off' }}">
      <input type="hidden" name="reference_url_1" value="{{ generation_reference_urls[0] if generation_reference_urls and generation_reference_urls|length > 0 else '' }}">
      <input type="hidden" name="reference_url_2" value="{{ generation_reference_urls[1] if generation_reference_urls and generation_reference_urls|length > 1 else '' }}">
      <input type="hidden" name="reference_url_3" value="{{ generation_reference_urls[2] if generation_reference_urls and generation_reference_urls|length > 2 else '' }}">
    {% endif %}

    <div class="form-group">
      <label for="tone">トーン</label>
      <select id="tone" name="tone" required {% if locked %}disabled{% endif %}>
        <option value="luxury" {% if generation_tone == 'luxury' %}selected{% endif %}>フォーマル・権威型（luxury）</option>
        <option value="casual_friendly" {% if generation_tone == 'casual_friendly' or not generation_tone %}selected{% endif %}>カジュアル・親しみ型（casual_friendly）</option>
        <option value="magazine_story" {% if generation_tone == 'magazine_story' %}selected{% endif %}>ストーリー型（magazine_story）</option>
        <option value="practical" {% if generation_tone == 'practical' %}selected{% endif %}>実用・標準（practical）</option>
      </select>
    </div>
    <div class="v0-check-row">
      <label class="v0-check-item">
        <input type="checkbox" name="include_brand_profile" {% if generation_include_brand_profile %}checked{% endif %} {% if locked %}disabled{% endif %}>
        ブランドプロフィールを含める
      </label>
      <label class="v0-check-item">
        <input type="checkbox" name="include_wearing_scenes" {% if generation_include_wearing_scenes %}checked{% endif %} {% if locked %}disabled{% endif %}>
        装着シーンを含める
      </label>
    </div>

    <div class="form-group v0-url-group">
      <label class="v0-url-label">参考URL（任意・最大3本）</label>

      <input
        class="v0-url-input"
        type="url"
        name="reference_url_1"
        value="{{ generation_reference_urls[0] if generation_reference_urls and generation_reference_urls|length > 0 else '' }}"
        placeholder="参考URL 1（推奨）: https://..."
        {% if locked %}disabled{% endif %}
      >

      <input
        class="v0-url-input"
        type="url"
        name="reference_url_2"
        value="{{ generation_reference_urls[1] if generation_reference_urls and generation_reference_urls|length > 1 else '' }}"
        placeholder="参考URL 2（任意）: https://..."
        {% if locked %}disabled{% endif %}
      >

      <input
        class="v0-url-input"
        type="url"
        name="reference_url_3"
        value="{{ generation_reference_urls[2] if generation_reference_urls and generation_reference_urls|length > 2 else '' }}"
        placeholder="参考URL 3（任意）: https://..."
        {% if locked %}disabled{% endif %}
      >

      <small class="v0-url-help">
        信頼できるURLを最大3本まで貼れます
      </small>
    </div>

    {% set quota_ok = (plan_mode == 'unlimited') or (monthly_remaining|default(0) > 0) %}
    <button type="submit" class="v0-generate-btn" data-quota-ok="{{ '1' if quota_ok else '0' }}" {% if not quota_ok %}disabled{% endif %}>記事作成</button>
    {% if not quota_ok %}
      <div class="v0-quota-error">※今月の生成上限に達しています</div>
    {% endif %}
  </form>

  {% if generated_intro_text or generated_specs_text %}
    <h3 class="v0-article-subtitle">生成結果</h3>
    {% if generation_elapsed_sec is defined and generation_elapsed_sec is not none %}
      <div class="v0-article-elapsed">所要時間: {{ '%.1f'|format(generation_elapsed_sec) }}秒</div>
    {% elif rewrite_elapsed_sec is defined and rewrite_elapsed_sec is not none %}
      <div class="v0-article-elapsed">所要時間: {{ '%.1f'|format(rewrite_elapsed_sec) }}秒</div>
    {% endif %}

    {% if selected_reference_url %}
      <div class="alert alert-info v0-article-ref">
        <div><strong>参考URL採用:</strong> {{ selected_reference_url }}</div>
        {% if selected_reference_reason %}
        <div><strong>理由:</strong> {{ selected_reference_reason }}</div>
        {% endif %}
      </div>
    {% endif %}

    {% set sim_cls = similarity_level|default('blue') %}
    <div class="alert v0-article-sim">
      <div>
        <strong>類似度:</strong>
        <span class="sim-badge {{ sim_cls }}">{{ similarity_percent|default(0) }}%</span>
        <span class="v0-article-sim-note">（blue / yellow / red）</span>
      </div>

      {% if saved_article_id and (rewrite_depth|default(0) == 0) %}
        <form method="POST" class="v0-article-rewrite-form">
          <input type="hidden" name="action" value="rewrite_once">
          <input type="hidden" name="brand" value="{{ brand }}">
          <input type="hidden" name="reference" value="{{ reference }}">
          <input type="hidden" name="source_article_id" value="{{ saved_article_id }}">
          <button type="submit" class="v0-article-rewrite-btn">言い換え再生成（1回）</button>
          <small class="v0-article-note">
            ※必要なときだけ押してください（最大1回）
          </small>
        </form>
      {% else %}
        <div class="v0-article-note">
          ※この文章は言い換え済みのため、再度の言い換えはできません（最大1回）
        </div>
      {% endif %}    
    </div>

    <div class="form-group v0-generated-block">
      <label for="generated_intro" class="v0-generated-label">【商品紹介文】 ({{ generated_intro_text|length }}文字)</label>
      <textarea id="generated_intro" class="v0-generated-textarea" readonly rows="10">{{ generated_intro_text }}</textarea>
      <button type="button" class="v0-generated-copy-btn" onclick="copyToClipboard('generated_intro')">コピー</button>
    </div>

    <div class="form-group v0-generated-block">
      <label for="generated_specs" class="v0-generated-label">【商品スペック】 ({{ generated_specs_text|length }}文字)</label>
      <textarea id="generated_specs" class="v0-generated-textarea" readonly rows="10">{{ generated_specs_text }}</textarea>
      <button type="button" class="v0-generated-copy-btn" onclick="copyToClipboard('generated_specs')">コピー</button>
    </div>

    <details style="margin-top:12px;">
      <summary>デバッグ：URL本文が取得できているか<span class="v0-collapsible-hint"></span></summary>
      <div style="font-size:12px; color:#444; margin-top:8px;">
        <div><strong>llm_client_file:</strong> {{ llm_client_file }}</div>
        <div><strong>raw_urls_debug:</strong> {{ raw_urls_debug }}</div>
        <div><strong>combined_reference_chars:</strong> {{ combined_reference_chars }}</div>
        <div><strong>preview:</strong> {{ combined_reference_preview }}</div>
        <div style="margin-top:8px;"><strong>per_url</strong></div>
        {% for d in reference_urls_debug %}
          <div style="margin-top:6px; padding:6px; border:1px solid #eee;">
            <div><strong>url:</strong> {{ d.url }}</div>
            <div>allowed={{ d.allowed }} fetch_ok={{ d.fetch_ok }} status={{ d.status }} ok={{ d.ok }} ref_hit={{ d.ref_hit }}</div>
            <div>method={{ d.method }} chars={{ d.chars }} filtered_reason={{ d.filtered_reason }}</div>
            <div>preview: {{ d.preview }}</div>
          </div>
        {% endfor %}
      </div>
    </details>
  {% endif %}
</section>

  {% if history %}
  <section class="v0-card v0-card-history">
    <h3><span class="v0-title-icon"><i data-lucide="history"></i></span>生成履歴（直近{{ history|length }}件）</h3>
    <div class="v0-history-list">

    {% for h in history %}
      <div class="v0-history-item">
        <div class="v0-history-head">
          <div class="v0-history-meta">
            <span class="v0-history-id">#{{ h.id }}</span>
            <span class="v0-history-date">{{ h.created_at }}</span>
          </div>
          {% set h_cls = (h.similarity_level or 'blue') %}
          <div class="v0-history-similarity">
            <span class="sim-badge {{ h_cls }}">類似度 {{ h.similarity_percent|default(0) }}%</span>
          </div>
        </div>

        <div class="v0-history-reference">
          <div class="v0-history-reference-url"><strong>参考URL採用:</strong> {{ h.selected_reference_url or '（なし）' }}</div>
          <div class="v0-history-reference-reason"><strong>理由:</strong> {{ h.selected_reference_reason or '（なし）' }}</div>
        </div>

        <details class="v0-history-details v0-history-intro">
          <summary>商品紹介文<span class="v0-collapsible-hint"></span></summary>
          <textarea id="hist_intro_{{ h.id }}" readonly rows="8">{{ h.intro_text }}</textarea>
          <button type="button" class="v0-history-copy-btn" onclick="copyToClipboard('hist_intro_{{ h.id }}')">紹介文をコピー</button>
        </details>

        <details class="v0-history-details v0-history-specs">
          <summary>商品スペック<span class="v0-collapsible-hint"></span></summary>
          <textarea id="hist_specs_{{ h.id }}" readonly rows="8">{{ h.specs_text }}</textarea>
          <button type="button" class="v0-history-copy-btn" onclick="copyToClipboard('hist_specs_{{ h.id }}')">スペックをコピー</button>
        </details>

        {% if (h.rewrite_depth|default(0) == 0) and ((plan_mode == 'unlimited') or (monthly_remaining|default(0) > 0)) %}
          <form method="POST" class="v0-history-rewrite-form">
            <input type="hidden" name="action" value="rewrite_once">
            <input type="hidden" name="brand" value="{{ brand }}">
            <input type="hidden" name="reference" value="{{ reference }}">
            <input type="hidden" name="source_article_id" value="{{ h.id }}">
            <button type="submit" class="v0-history-rewrite-btn" onclick="this.disabled=true; this.form.submit();">この履歴を言い換え再生成（1回）</button>
          </form>
        {% elif (h.rewrite_depth|default(0) != 0) %}
          <div class="v0-history-note">
            ※この履歴は言い換え済みのため、再度の言い換えはできません（最大1回）
          </div>
        {% else %}
          <div class="v0-history-note v0-history-note-error">
            ※今月の生成上限に達しているため、言い換えできません
          </div>
        {% endif %}
      </div>
    {% endfor %}
    </div>
  </section>
  {% endif %}

{% endif %}

{% if recent_generations %}
  <section class="v0-card v0-card-recent">
    <h2 style="margin:0 0 8px 0;"><span class="v0-title-icon"><i data-lucide="clock-3"></i></span>直近の作成10件</h2>
    <div class="v0-recent-list">
    {% for g in recent_generations %}
      <div class="v0-recent-row">
        <div class="v0-recent-main">
          <span class="v0-recent-rank">{{ loop.index }}</span>
          <div class="v0-recent-title">
            <a class="v0-recent-link" href="{{ url_for('staff_search', brand=g.brand, reference=g.reference) }}">
              <span class="v0-recent-brand">{{ g.brand }}</span>
              <span class="v0-recent-divider">/</span>
              <span class="v0-recent-ref">{{ g.reference }}</span>
            </a>
          </div>
        </div>
        <div class="v0-recent-meta">
          {% if g.elapsed_ms is not none %}
            <span class="v0-recent-duration">{{ '%.1f'|format(g.elapsed_ms / 1000) }}秒</span>
          {% endif %}
          <span class="v0-recent-date">{{ g.created_at_jst }}</span>
        </div>
      </div>
    {% endfor %}
    </div>
  </section>
{% endif %}

<section class="v0-card v0-card-summary">
  <h2 style="margin:0 0 8px 0;"><span class="v0-title-icon"><i data-lucide="watch"></i></span>サマリー</h2>
  <div class="v0-summary-total">全商品登録数 : <strong>{{ total_product_count }}</strong></div>
  {% if brand_summaries and brand_summaries|length > 0 %}
  <div class="v0-summary-table-wrap">
    <table class="v0-summary-table">
      <thead>
        <tr>
          <th>ブランド名</th>
          <th>商品登録数</th>
          <th>今月の作成数</th>
          <th>直近の作成リファレンス</th>
        </tr>
      </thead>
      <tbody>
        {% for row in brand_summaries %}
        <tr>
          <td class="v0-summary-brand">{{ row.brand }}</td>
          <td class="v0-summary-num">{{ row.product_count }}</td>
          <td class="v0-summary-num">{{ row.monthly_generations }}</td>
          <td class="v0-summary-ref">
            {% if row.latest_reference %}
              {% set ns = namespace(latest_match=None) %}
              {% if recent_generations %}
                {% for g in recent_generations %}
                  {% if ns.latest_match is none and (g.reference == row.latest_reference) and (g.brand|trim|lower == row.brand|trim|lower) %}
                    {% set ns.latest_match = g %}
                  {% endif %}
                {% endfor %}
              {% endif %}
              {% if ns.latest_match %}
                <a class="v0-summary-link" href="{{ url_for('staff_search', brand=ns.latest_match.brand, reference=ns.latest_match.reference) }}">{{ row.latest_reference }}</a>
              {% else %}
                {{ row.latest_reference }}
              {% endif %}
            {% else %}
              —
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="v0-summary-empty">データなし</div>
  {% endif %}
</section>

<script src="https://unpkg.com/lucide@latest"></script>
<script>
function copyToClipboard(elementId) {
  const el = document.getElementById(elementId);
  if (!el) return;
  el.select();
  el.setSelectionRange(0, 999999);
  document.execCommand('copy');
  alert('コピーしました');
}
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  if (window.lucide && typeof window.lucide.createIcons === 'function') {
    window.lucide.createIcons();
  }
  const brandSelect = document.getElementById('brand');
  const referenceInput = document.getElementById('reference');
  const referenceSuggestions = document.getElementById('reference_suggestions');
  const refCount = document.getElementById('ref_count');
  const refLoading = document.getElementById('ref_loading');
  const generateForm = document.querySelector('form.v0-article-form');
  const generateButton = generateForm ? generateForm.querySelector('.v0-generate-btn') : null;
  const staffAdditionalInput = document.getElementById('staff_additional_input');
  const savedStaffAdditionalInput = document.getElementById('saved_staff_additional_input');
  const staffRequiredNote = document.getElementById('staff_additional_input_required_note');

  if (!brandSelect || !referenceInput || !referenceSuggestions || !refCount || !refLoading) {
    return;
  }

  const deleteOverrideButton = document.querySelector('.js-double-confirm-delete');
  if (deleteOverrideButton) {
    deleteOverrideButton.addEventListener('click', (event) => {
      const firstConfirmed = window.confirm('スペック修正を解除しても良いですか？');
      if (!firstConfirmed) {
        event.preventDefault();
        return;
      }
      const secondConfirmed = window.confirm('確認：スペック修正を解除しても良いですか？');
      if (!secondConfirmed) {
        event.preventDefault();
      }
    });
  }

  const refCache = new Map();
  let requestId = 0;
  let referenceItems = [];

  function hideSuggestions() {
    referenceSuggestions.hidden = true;
    referenceSuggestions.innerHTML = '';
  }

  function clearOptions() {
    referenceItems = [];
    hideSuggestions();
  }

  function renderSuggestions(query) {
    const q = (query || '').trim().toLowerCase();
    const filtered = q
      ? referenceItems.filter((ref) => ref.toLowerCase().includes(q))
      : referenceItems;
    const limited = filtered.slice(0, 80);

    if (!limited.length || referenceInput.disabled) {
      hideSuggestions();
      return;
    }

    referenceSuggestions.innerHTML = '';
    for (const ref of limited) {
      const option = document.createElement('button');
      option.type = 'button';
      option.className = 'v0-reference-option';
      option.textContent = ref;
      option.addEventListener('mousedown', (e) => {
        e.preventDefault();
        referenceInput.value = ref;
        hideSuggestions();
      });
      referenceSuggestions.appendChild(option);
    }
    referenceSuggestions.hidden = false;
  }

  function applyOptions(items) {
    referenceItems = Array.isArray(items) ? items : [];
    renderSuggestions(referenceInput.value);
  }

  function setIdleState() {
    referenceInput.disabled = false;
    refLoading.style.display = 'none';
  }

  async function updateReferences() {
    const brand = (brandSelect.value || '').trim();
    const currentRequest = ++requestId;

    if (!brand) {
      clearOptions();
      refCount.textContent = '登録数: -';
      setIdleState();
      return;
    }

    if (refCache.has(brand)) {
      const cached = refCache.get(brand);
      applyOptions(cached.items);
      refCount.textContent = `登録数: ${cached.count}件`;
      setIdleState();
      return;
    }

    referenceInput.disabled = true;
    refLoading.style.display = 'inline';
    refCount.textContent = '登録数: 読み込み中…';

    try {
      const referencesUrl = brandSelect.dataset.referencesUrl || '/staff/references';
      const res = await fetch(`${referencesUrl}?brand=${encodeURIComponent(brand)}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      if (currentRequest !== requestId) return;

      const items = Array.isArray(data.items) ? data.items : [];
      const count = Number.isFinite(Number(data.count)) ? Number(data.count) : items.length;
      refCache.set(brand, { count, items });
      applyOptions(items);
      refCount.textContent = `登録数: ${count}件`;
      setIdleState();
    } catch (_e) {
      if (currentRequest !== requestId) return;
      clearOptions();
      refCount.textContent = '登録数: 取得失敗';
      setIdleState();
    }
  }

  referenceInput.addEventListener('focus', () => renderSuggestions(referenceInput.value));
  referenceInput.addEventListener('input', () => renderSuggestions(referenceInput.value));
  referenceInput.addEventListener('blur', () => {
    setTimeout(() => hideSuggestions(), 120);
  });
  referenceInput.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') hideSuggestions();
  });

  document.addEventListener('click', (e) => {
    if (!referenceSuggestions.contains(e.target) && e.target !== referenceInput) {
      hideSuggestions();
    }
  });

  function updateGenerateButtonState() {
    if (!generateButton || !staffAdditionalInput) return;
    const hasStaffInput = (staffAdditionalInput.value || '').trim() !== '';
    const quotaOk = generateButton.dataset.quotaOk === '1';
    generateButton.disabled = !quotaOk || !hasStaffInput;
    if (staffRequiredNote) {
      staffRequiredNote.style.display = hasStaffInput ? 'none' : 'block';
    }
  }

  if (generateForm && staffAdditionalInput) {
    staffAdditionalInput.addEventListener('input', updateGenerateButtonState);
    updateGenerateButtonState();

    generateForm.addEventListener('submit', (event) => {
      let hiddenStaffInput = generateForm.querySelector('input[name="staff_additional_input"]');
      if (!hiddenStaffInput) {
        hiddenStaffInput = document.createElement('input');
        hiddenStaffInput.type = 'hidden';
        hiddenStaffInput.name = 'staff_additional_input';
        generateForm.appendChild(hiddenStaffInput);
      }

      const current = (staffAdditionalInput.value || '').trim();
      const saved = savedStaffAdditionalInput ? (savedStaffAdditionalInput.value || '').trim() : '';
      hiddenStaffInput.value = current;

      if (!current) {
        event.preventDefault();
        updateGenerateButtonState();
        return;
      }

      const brandValue = (brandSelect && brandSelect.value ? brandSelect.value : '').trim();
      const referenceValue = (referenceInput && referenceInput.value ? referenceInput.value : '').trim();
      const confirmMessage = (brandValue && referenceValue)
        ? `${brandValue} / ${referenceValue} で記事を作成しても良いですか？`
        : '入力内容で記事を作成しても良いですか？';
      if (!window.confirm(confirmMessage)) {
        event.preventDefault();
        return;
      }

      if (current !== '' && current !== saved) {
        window.alert("スタッフの体験談を追加して文章を生成します");
      }
    });
  }

  brandSelect.addEventListener('change', updateReferences);

  if ((brandSelect.value || '').trim()) {
    updateReferences();
  } else {
    clearOptions();
    refCount.textContent = '登録数: -';
  }
});
</script>

<script>
(() => {
  const hourHand = document.getElementById('clock_hour_hand');
  const minuteHand = document.getElementById('clock_minute_hand');
  const secondHand = document.getElementById('clock_second_hand');
  const digitalTime = document.getElementById('clock_time');
  const digitalDate = document.getElementById('clock_date');

  if (!hourHand || !minuteHand || !secondHand || !digitalTime || !digitalDate) {
    return;
  }

  const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

  function renderClock(now) {
    const hours = now.getHours() % 12;
    const minutes = now.getMinutes();
    const seconds = now.getSeconds();

    const hourDeg = hours * 30 + minutes * 0.5;
    const minuteDeg = minutes * 6;
    const secondDeg = seconds * 6;

    hourHand.style.transform = `rotate(${hourDeg}deg)`;
    minuteHand.style.transform = `rotate(${minuteDeg}deg)`;
    secondHand.style.transform = `rotate(${secondDeg}deg)`;

    const h = String(now.getHours()).padStart(2, '0');
    const m = String(now.getMinutes()).padStart(2, '0');
    const s = String(now.getSeconds()).padStart(2, '0');
    const y = now.getFullYear();
    const mo = String(now.getMonth() + 1).padStart(2, '0');
    const d = String(now.getDate()).padStart(2, '0');

    digitalTime.textContent = `${h}:${m}:${s}`;
    digitalDate.textContent = `${y}/${mo}/${d} ${weekdays[now.getDay()]}`;
  }

  renderClock(new Date());

  const now = new Date();
  const msToNextSecond = 1000 - now.getMilliseconds();
  setTimeout(() => {
    renderClock(new Date());
    setInterval(() => renderClock(new Date()), 1000);
  }, msToNextSecond);
})();
</script>
{% endif %}

</div>
{% endblock %}
