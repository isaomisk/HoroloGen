{% extends "base.html" %}

{% block title %}Admin: CSVアップロード - HoroloGen{% endblock %}

{% block content %}
<h1>Admin: CSVアップロード・インポート</h1>
<p style="margin-bottom: 16px;">
    <a href="{{ url_for('admin_tenants') }}">テナント一覧へ</a>
    |
    <a href="{{ url_for('admin_users') }}">ユーザー一覧へ</a>
    |
    <a href="{{ url_for('admin_tenant_new') }}">テナント作成へ</a>
    |
    <a href="{{ url_for('admin_user_new') }}">ユーザー作成へ</a>
</p>

<form method="POST" enctype="multipart/form-data">
    <div class="form-group">
        <label for="tenant_id">対象テナント</label>
        <select id="tenant_id" name="tenant_id" required>
            <option value="">選択してください</option>
            {% for t in tenants %}
            <option value="{{ t.id }}" {% if selected_tenant_id == t.id %}selected{% endif %}>
                {{ t.name }} (id={{ t.id }})
            </option>
            {% endfor %}
        </select>
    </div>
    <div class="form-group">
        <label for="csv_file">CSVファイルを選択（UTF-8形式）</label>
        <input type="file" id="csv_file" name="csv_file" accept=".csv" required>
    </div>
    
    <button type="submit">アップロード・インポート</button>
</form>

<div style="margin-top: 30px;">
    <h2>Staff パスワード再発行</h2>
    <p style="color: #666;">再発行後、対象ユーザーは次回ログイン時にパスワード変更が必須になります。</p>

    {% if reset_password_notice %}
    <div style="margin: 12px 0; background: #fff8db; border: 1px solid #efd38a; padding: 12px; border-radius: 6px;">
        <p><strong>再発行対象:</strong> {{ reset_password_notice.email }}</p>
        <p><strong>仮パスワード（1回表示）:</strong> <code>{{ reset_password_notice.temporary_password }}</code></p>
    </div>
    {% endif %}

    <table style="width: 100%; border-collapse: collapse; margin-top: 12px;">
        <thead>
            <tr>
                <th style="text-align: left; border-bottom: 1px solid #ddd; padding: 8px;">Email</th>
                <th style="text-align: left; border-bottom: 1px solid #ddd; padding: 8px;">Tenant ID</th>
                <th style="text-align: left; border-bottom: 1px solid #ddd; padding: 8px;">Action</th>
            </tr>
        </thead>
        <tbody>
            {% for u in staff_users %}
            <tr>
                <td style="padding: 8px; border-bottom: 1px solid #eee;">{{ u.email }}</td>
                <td style="padding: 8px; border-bottom: 1px solid #eee;">{{ u.tenant_id }}</td>
                <td style="padding: 8px; border-bottom: 1px solid #eee;">
                    <form
                        method="POST"
                        action="{{ url_for('admin_reset_password', user_id=u.id) }}"
                        style="display: inline;"
                        onsubmit="return confirm('本当に再発行しますか？');"
                    >
                        <input
                            type="hidden"
                            name="next"
                            value="{% if selected_tenant_id %}{{ url_for('admin_upload', tenant_id=selected_tenant_id) }}{% else %}{{ url_for('admin_upload') }}{% endif %}"
                        >
                        <button type="submit">仮パスワード再発行</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div style="margin-top: 30px;">
    <h2>CSVファイル形式</h2>
    <p>以下のカラムを含む必要があります（順序は任意）：</p>
    <ul style="margin-left: 20px; margin-top: 10px;">
        <li>brand, reference（必須）</li>
        <li>price_jpy, case_size_mm, movement, case_material</li>
        <li>bracelet_strap, dial_color, water_resistance_m, buckle</li>
        <li>warranty_years, collection, movement_caliber</li>
        <li>case_thickness_mm, lug_width_mm, remarks</li>
    </ul>
    <p style="margin-top: 10px; color: #666;">
        <strong>注意:</strong> brandとreferenceが空の行はスキップされます。不正なカラムが含まれている場合はインポートが停止されます。
    </p>
</div>

{% if latest_upload %}
<div style="margin-top: 30px;">
    <h2>最新のインポート結果</h2>
    <div style="background-color: #f5f5f5; padding: 15px; border-radius: 5px;">
        <p><strong>ファイル名:</strong> {{ latest_upload.filename }}</p>
        <p><strong>アップロード日時:</strong> {{ latest_upload.uploaded_at }}</p>
        <p><strong>総行数:</strong> {{ latest_upload.total_rows }}</p>
        <p><strong>新規:</strong> {{ latest_upload.inserted_count }}</p>
        <p><strong>更新:</strong> {{ latest_upload.updated_count }}</p>
        <p><strong>エラー:</strong> {{ latest_upload.error_count }}</p>
        <p><strong>変更:</strong> {{ latest_upload.changed_count or 0 }}</p>
        <p><strong>オーバーライド競合:</strong> {{ latest_upload.override_conflict_count or 0 }}</p>
    </div>
    
    {% if sample_diffs %}
    <div style="margin-top: 20px;">
        <h3>サンプル差分（最大10件）</h3>
        <div style="background-color: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
            {% for diff_item in sample_diffs %}
            <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                <p><strong>{{ diff_item.brand }} / {{ diff_item.reference }}</strong></p>
                <ul style="margin-left: 20px;">
                    {% for diff in diff_item.diffs %}
                    <li>
                        <strong>{{ diff.field }}:</strong> 
                        "{{ diff.old }}" → "{{ diff.new }}"
                        {% if diff.override_exists %}
                        <span style="color: #d9534f; font-weight: bold;">（オーバーライド存在）</span>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endif %}
{% endblock %}
