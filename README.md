# HoroloGen MVP Step1

時計商品マスタ管理システムのMVP（最小実行可能製品）Step1です。

## 機能概要

1. **Admin: CSVアップロード・インポート**
   - CSVファイル（UTF-8）をアップロードしてSQLiteデータベースにインポート
   - ブランドとリファレンスの組み合わせでUPSERT（新規挿入または更新）
   - インポート結果の統計表示（総行数、新規、更新、エラー）

2. **Staff: 検索・オーバーライド**
   - ブランドとリファレンスで商品を検索
   - マスタデータの手動オーバーライド機能
   - 正規仕様（Canonical Specs）の自動計算と表示

## セットアップ手順

### 1. 必要な環境

- Python 3.8以上
- pip（Pythonパッケージマネージャー）

### 2. 依存パッケージのインストール

```bash
pip install -r requirements.txt
```

### 3. データベースの初期化

アプリケーションを初めて起動すると、自動的にSQLiteデータベース（`horologen.db`）が作成されます。

### 4. アプリケーションの起動

```bash
python app.py
```

ブラウザで以下のURLにアクセス：
- Admin画面: http://localhost:5000/admin/upload
- Staff画面: http://localhost:5000/staff/search

## CSVファイル形式

### 必須カラム

CSVファイルには以下のカラムを含む必要があります（順序は任意）：

```
brand,reference,price_jpy,case_size_mm,movement,case_material,bracelet_strap,dial_color,water_resistance_m,buckle,warranty_years,collection,movement_caliber,case_thickness_mm,lug_width_mm,remarks
```

### カラム説明

| カラム名 | 説明 | 必須 |
|---------|------|------|
| brand | ブランド名 | ✓ |
| reference | リファレンス番号 | ✓ |
| price_jpy | 価格（日本円） | |
| case_size_mm | ケースサイズ（mm） | |
| movement | ムーブメント（automatic/manual/quartz等） | |
| case_material | ケース材質 | |
| bracelet_strap | ブレスレット/ストラップ（bracelet/strap） | |
| dial_color | ダイアルカラー | |
| water_resistance_m | 耐水性能（m） | |
| buckle | バックル（pin/D） | |
| warranty_years | 保証期間（年） | |
| collection | コレクション名 | |
| movement_caliber | ムーブメントキャリバー | |
| case_thickness_mm | ケース厚さ（mm） | |
| lug_width_mm | ラグ幅（mm） | |
| remarks | 備考 | |

### 注意事項

- CSVファイルはUTF-8エンコーディングである必要があります
- `brand`と`reference`が空の行はスキップされます
- 必須カラム以外のカラムが含まれている場合、インポートは停止されます
- ブランドとリファレンスの組み合わせが既に存在する場合、データが更新されます

## テスト手順

### 1. CSVインポートのテスト

1. サンプルCSVファイル（`data/HoroloGen_product_master_sample.csv`）を使用
2. Admin画面（http://localhost:5000/admin/upload）にアクセス
3. 「CSVファイルを選択」でサンプルファイルを選択
4. 「アップロード・インポート」ボタンをクリック
5. インポート結果メッセージを確認
   - 総行数、新規、更新、エラーの数が表示されることを確認

### 2. 検索機能のテスト

1. Staff画面（http://localhost:5000/staff/search）にアクセス
2. ブランドを選択（例: `omega`）
3. リファレンスを入力（例: `310.30.42.50.01.002`）
4. 「検索」ボタンをクリック
5. 正規仕様が表示されることを確認
6. マスタデータが存在しない場合、警告メッセージが表示されることを確認

### 3. オーバーライド機能のテスト

1. 検索結果が表示された状態で、オーバーライド編集フォームを使用
2. いくつかのフィールドを編集（例: `price_jpy`を変更）
3. 「オーバーライドを保存」ボタンをクリック
4. 保存成功メッセージを確認
5. 再度検索して、正規仕様にオーバーライド値が反映されていることを確認
6. オーバーライドされたフィールドに「オーバーライド」バッジが表示されることを確認

### 4. 正規仕様の計算テスト

1. マスタデータのみが存在する商品を検索
   - 正規仕様にマスタ値が表示されることを確認
2. オーバーライドを保存した商品を検索
   - 正規仕様にオーバーライド値が優先して表示されることを確認
3. オーバーライドが空のフィールドは、マスタ値が表示されることを確認

### 5. エラーハンドリングのテスト

1. **不正なCSVカラム**
   - 必須カラム以外を含むCSVをアップロード
   - エラーメッセージが表示され、インポートが停止されることを確認

2. **必須フィールド欠損**
   - `brand`または`reference`が空の行を含むCSVをアップロード
   - 該当行がスキップされ、エラーカウントに含まれることを確認

3. **価格欠損警告**
   - `price_jpy`がマスタとオーバーライドの両方で空の商品を検索
   - 警告メッセージが表示されることを確認

### 6. オーバーライド解除機能のテスト

1. オーバーライドが設定されている商品を検索
2. 「オーバーライド解除（マスタに戻す）」ボタンが表示されることを確認
3. ボタンをクリックして確認ダイアログを確認
4. 確認してオーバーライドを解除
5. 成功メッセージを確認
6. 再度検索して、正規仕様にマスタ値が表示されることを確認
7. オーバーライドバッジが表示されないことを確認

### 7. CSV再インポート差分検出のテスト

1. 既存のマスタデータを含むCSVファイルを準備
2. いくつかのフィールドを変更したCSVファイルを作成
3. 変更したCSVファイルをアップロード
4. インポート完了メッセージに「変更」と「オーバーライド競合」の数が表示されることを確認
5. Admin画面で最新のインポート結果を確認
   - 変更数とオーバーライド競合数が表示されることを確認
   - サンプル差分（最大10件）が表示されることを確認
   - 各差分に「オーバーライド存在」の表示があることを確認（該当する場合）

### 8. オーバーライド競合警告のテスト

1. オーバーライドが設定されている商品を検索
2. オーバーライド警告バナーが表示されることを確認
3. その商品のマスタデータを変更したCSVをインポート
4. 再度その商品を検索
5. オーバーライド警告と追加警告（「最新のインポートでこの商品が変更されましたが、オーバーライドが存在します」）が表示されることを確認

### 9. ダミー記事生成のテスト

1. Staff画面（http://localhost:5000/staff/search）にアクセス
2. ブランドとリファレンスを入力して商品を検索
3. 正規仕様（Canonical Specs）が表示されることを確認
4. 「記事生成（ダミー）」セクションが表示されることを確認
5. トーンを選択（luxury / practical / magazine / ec）
6. オプションを選択：
   - 「ブランドプロフィールを含める」チェックボックス
   - 「装着シーンを含める」チェックボックス
7. 「記事生成（ダミー）」ボタンをクリック
8. 生成結果が表示されることを確認：
   - 【商品紹介文】テキストエリア（最大1500文字）
   - 【商品スペック】テキストエリア（最大1000文字）
9. 各テキストエリアの「コピー」ボタンで内容をコピーできることを確認
10. 生成された紹介文に以下が含まれることを確認：
    - サイズ感の説明
    - ムーブメントの解説
    - 現在の定価（または「定価：未記載」）
11. 生成されたスペックが正規仕様から構築されたラベル付きリストであることを確認
12. 異なるトーンを選択して生成し、文体が変わることを確認
13. オプションのチェックボックスを変更して生成し、内容が変わることを確認
14. 文字数制限（紹介文1500文字、スペック1000文字）が守られていることを確認

## データベース構造

### master_products テーブル

商品マスタデータを格納します。`(brand, reference)`の組み合わせでユニーク制約があります。

### product_overrides テーブル

手動オーバーライドデータを格納します。`(brand, reference)`の組み合わせでユニーク制約があります。

### master_uploads テーブル

CSVアップロード履歴を格納します。

## 次のステップ（改善提案）

1. **認証・認可機能**
   - AdminとStaffのロール分離
   - ログイン機能の追加

2. **データ検証の強化**
   - 各フィールドのデータ型検証
   - 数値フィールドの範囲チェック

3. **UI/UXの改善**
   - レスポンシブデザイン
   - より直感的なインターフェース
   - バリデーションメッセージの改善

4. **機能拡張**
   - 一括オーバーライド機能
   - オーバーライド履歴の表示
   - エクスポート機能（CSV/JSON）

5. **パフォーマンス改善**
   - 大量データ対応
   - インデックスの最適化

6. **テストの追加**
   - ユニットテスト
   - 統合テスト

## トラブルシューティング

### データベースエラー

- `horologen.db`ファイルを削除して再起動すると、データベースが再初期化されます

### CSVインポートエラー

- CSVファイルがUTF-8エンコーディングであることを確認
- カラム名に余分な空白がないか確認
- 必須カラムがすべて含まれているか確認

### ポートが使用中

- デフォルトポート（5000）が使用中の場合は、`app.py`の最後の行でポート番号を変更してください

## ライセンス

このプロジェクトは内部使用を目的としています。
